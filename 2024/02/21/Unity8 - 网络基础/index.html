

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Wanderer">
  <meta name="keywords" content="">
  
    <meta name="description" content="Unity8 - 网络基础">
<meta property="og:type" content="article">
<meta property="og:title" content="Unity8 - 网络基础">
<meta property="og:url" content="http://zxk2099.github.io/2024/02/21/Unity8%20-%20%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/index.html">
<meta property="og:site_name" content="Wandering Notes">
<meta property="og:description" content="Unity8 - 网络基础">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-02-20T16:50:33.000Z">
<meta property="article:modified_time" content="2024-02-21T06:48:58.708Z">
<meta property="article:author" content="Wanderer">
<meta property="article:tag" content="Unity">
<meta property="article:tag" content="网络">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>Unity8 - 网络基础 - Wandering Notes</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"zxk2099.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":60,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Wandering Notes</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                
                <span>时间线</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                
                <span>归类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Unity8 - 网络基础"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-02-21 00:50" pubdate>
          2024年2月21日 凌晨00:50
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          13k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          111 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Unity8 - 网络基础</h1>
            
            
              <div class="markdown-body">
                
                <p>Unity8 - 网络基础</p>
<span id="more"></span>
<!-- omit in toc -->
<h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ul>
<li><a href="#%E6%AD%A3%E6%96%87">正文</a><ul>
<li><a href="#%E5%9F%BA%E7%A1%80%E7%90%86%E8%AE%BA">基础理论</a><ul>
<li><a href="#%E7%BD%91%E7%BB%9C%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5">网络基本概念</a></li>
<li><a href="#ip-%E7%AB%AF%E5%8F%A3-mac%E5%9C%B0%E5%9D%80"><code>IP</code>, 端口, <code>Mac</code>地址</a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%9E%8B">数据通信模型</a></li>
</ul>
</li>
<li><a href="#%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE">网络协议</a><ul>
<li><a href="#osi%E6%A8%A1%E5%9E%8B"><code>OSI</code>模型</a></li>
<li><a href="#tcpip%E5%8D%8F%E8%AE%AE"><code>TCP</code>&#x2F;<code>IP</code>协议</a></li>
</ul>
</li>
<li><a href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1">网络通信</a><ul>
<li><a href="#%E9%80%9A%E4%BF%A1%E5%89%8D">通信前</a></li>
<li><a href="#%E7%BD%91%E7%BB%9C%E6%B8%B8%E6%88%8F%E9%80%9A%E4%BF%A1%E6%96%B9%E6%A1%88">网络游戏通信方案</a></li>
<li><a href="#%E5%A5%97%E6%8E%A5%E5%AD%97socket%E7%B1%BB">套接字<code>Socket</code>类</a><ul>
<li><a href="#%E5%B8%B8%E7%94%A8api">常用<code>API</code></a></li>
<li><a href="#%E9%80%9A%E4%BF%A1%E6%B5%81%E7%A8%8B">通信流程</a></li>
<li><a href="#tcp%E5%90%8C%E6%AD%A5"><code>TCP</code>同步</a></li>
<li><a href="#tcp%E5%BC%82%E6%AD%A5"><code>TCP</code>异步</a></li>
<li><a href="#udp%E5%90%8C%E6%AD%A5"><code>UDP</code>同步</a></li>
<li><a href="#udp%E5%BC%82%E6%AD%A5"><code>UDP</code>异步</a></li>
</ul>
</li>
<li><a href="#%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93ftp">文件传输<code>FTP</code></a><ul>
<li><a href="#%E6%90%AD%E5%BB%BAftp%E6%9C%8D%E5%8A%A1%E5%99%A8">搭建<code>FTP</code>服务器</a></li>
<li><a href="#%E4%B8%8A%E4%BC%A0">上传</a></li>
<li><a href="#%E4%B8%8B%E8%BD%BD">下载</a></li>
<li><a href="#ftp%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C"><code>FTP</code>其他操作</a></li>
</ul>
</li>
<li><a href="#%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93http">超文本传输<code>HTTP</code></a><ul>
<li><a href="#%E5%8E%9F%E7%90%86">原理</a></li>
<li><a href="#%E6%90%AD%E5%BB%BAhttp%E6%9C%8D%E5%8A%A1%E5%99%A8">搭建<code>http</code>服务器</a></li>
<li><a href="#c%E7%9B%B8%E5%85%B3%E7%B1%BB"><code>C#</code>相关类</a></li>
<li><a href="#unity%E7%9B%B8%E5%85%B3%E7%B1%BB"><code>Unity</code>相关类</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86">消息处理</a><ul>
<li><a href="#%E5%88%86%E5%8C%85%E4%B8%8E%E9%BB%8F%E5%8C%85">分包与黏包</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E5%B7%A5%E5%85%B7">自定义协议工具</a></li>
<li><a href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E5%8D%8F%E8%AE%AE%E5%B7%A5%E5%85%B7protobuf">第三方协议工具<code>Protobuf</code></a><ul>
<li><a href="#protobuf"><code>Protobuf</code></a></li>
<li><a href="#protobuf-net"><code>Protobuf-Net</code></a></li>
</ul>
</li>
<li><a href="#%E5%A4%A7%E5%B0%8F%E7%AB%AF%E6%A8%A1%E5%BC%8F%E5%A4%A7%E5%B0%8F%E7%AB%AF%E5%AD%97%E8%8A%82%E5%BA%8F">大小端模式&#x2F;大小端字节序</a></li>
<li><a href="#%E6%B6%88%E6%81%AF%E5%8A%A0%E5%AF%86%E4%B8%8E%E8%A7%A3%E5%AF%86">消息加密与解密</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a><a href="#%E7%9B%AE%E5%BD%95">正文</a></h1><h2 id="基础理论"><a href="#基础理论" class="headerlink" title="基础理论"></a><a href="#%E7%9B%AE%E5%BD%95">基础理论</a></h2><h3 id="网络基本概念"><a href="#网络基本概念" class="headerlink" title="网络基本概念"></a><a href="#%E5%9F%BA%E7%A1%80%E7%90%86%E8%AE%BA">网络基本概念</a></h3><ul>
<li>网络</li>
<li>局域网<code>LAN</code>(Local Area Network): 一个小区域内的多台设备相互连接形成的计算机组</li>
<li>以太网: 一种计算机局域网技术, 目前应用最普遍的局域网技术, 该技术规定了网络连接的一些规则&#x2F;协议<ul>
<li>以太网网络拓扑结构: 设备相互连接起来的物理布局构成的几何形状<ul>
<li>树形,网状,总线型,环形,星型</li>
</ul>
</li>
</ul>
</li>
<li>城域网<code>MAN</code>(Metropolitan Area Network): 城市范围的网络</li>
<li>广域网<code>WAN</code>(Wide Area Network): 超长距离专线连接的网络, 网状结构</li>
<li>互联网(因特网)</li>
<li>万维网: 存储在连接到因特网的计算机上的网页的集合</li>
</ul>
<h3 id="IP-端口-Mac地址"><a href="#IP-端口-Mac地址" class="headerlink" title="IP, 端口, Mac地址"></a><a href="#%E5%9F%BA%E7%A1%80%E7%90%86%E8%AE%BA"><code>IP</code>, 端口, <code>Mac</code>地址</a></h3><blockquote>
<p>作用: 互联设备中的设备地址</p>
</blockquote>
<ul>
<li><code>IP</code>地址(Internet Protocol Address)&#x2F;网际协议地址: 按协议规定的设备在网络中的具体地址, 用于定位<ul>
<li>按协议分<ul>
<li><code>IPv4</code>:从<code>0.0.0.0</code>到<code>255.255.255.255</code></li>
<li><code>IPv6</code>:从<code>0:0:0:0:0:0:0:0</code>到<code>65535:65535:65535:65535:65535:65535:65535:65535</code></li>
</ul>
</li>
<li>按使用范围分<ul>
<li>公网<code>IP</code>: 想要连接外网, 和远程设备通信时使用的<code>IP</code></li>
<li>私网<code>IP</code>&#x2F;局域网<code>IP</code>: 只能在局域网内通信</li>
</ul>
</li>
</ul>
</li>
<li>端口: 区分一个设备上的不同应用程序, 从<code>0</code>到<code>65535</code>, 需要自定义不能与其他程序相同的端口号, 一般<code>1024</code>以上</li>
<li><code>Mac</code>地址Media Access Control Address: 在网络中标识一个网卡的地址, 通常为12个16进制数, 由网卡制造商写入</li>
</ul>
<h3 id="数据通信模型"><a href="#数据通信模型" class="headerlink" title="数据通信模型"></a><a href="#%E5%9F%BA%E7%A1%80%E7%90%86%E8%AE%BA">数据通信模型</a></h3><ul>
<li>数据通信模型<ul>
<li>分散式<code>Decentralized</code>: 每一个计算机之间没有信息共享</li>
<li>集中式<code>Centralized</code>: 一个中心计算机保存所有数据, 其他计算机访问中心计算机获得数据</li>
<li>分布式<code>Distributed</code>: 两者的混合</li>
</ul>
</li>
<li><code>C/S</code>模型: 客户端<code>Client</code>和服务端<code>Server</code>模式</li>
<li><code>B/S</code>模型: 基于Web的通信模型(<code>Browse/Server</code>), 使用HTTP传送信息, 是一种特殊的<code>C/S</code>模型, 特殊之处在于客户端是浏览器, 不用自己开发</li>
<li><code>P2P</code>模型: 对等互联(<code>Peer-to-Peer</code>), 每一个设备同时运行<code>Client</code>和<code>Server</code>部分, 游戏一般不用</li>
</ul>
<h2 id="网络协议"><a href="#网络协议" class="headerlink" title="网络协议"></a><a href="#%E7%9B%AE%E5%BD%95">网络协议</a></h2><ul>
<li>计算机之间交换信息时约定的规则</li>
<li><code>OSI</code>模型是网络通信的基本规则, <code>TCP</code>&#x2F;<code>IP</code>协议是基于<code>OSI</code>模型的工业实现</li>
</ul>
<h3 id="OSI模型"><a href="#OSI模型" class="headerlink" title="OSI模型"></a><a href="#%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE"><code>OSI</code>模型</a></h3><ul>
<li>Open System Interconnection Reference Model是一种概念模型, 所有计算机都遵守这个规则就可以互相通信, 包含七个层级: 应用层,表示层, 会话层, 传输层, 网络层, 数据链路层, 物理层</li>
<li>物理层: 真正的二进制数据</li>
<li>数据链路层: 确定Mac地址head信息, 分离head和data</li>
<li>网络层: 确定IP地址, 路由等head信息</li>
<li>传输层: 提供端口, 版本, 协议等head信息</li>
<li>应用层: 提供原始数据data和协议(FTP,HTTP,SMTP等)head信息</li>
<li>表示层: 数据格式转化, 能与各系统兼容的格式和统一通用格式之间互换</li>
<li>会话层: 通信管理, 判断是否发送完毕, 是否收到, 管理断开连接等功能</li>
</ul>
<h3 id="TCP-IP协议"><a href="#TCP-IP协议" class="headerlink" title="TCP&#x2F;IP协议"></a><a href="#%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE"><code>TCP</code>&#x2F;<code>IP</code>协议</a></h3><ul>
<li>Transmission Control Protocol&#x2F;Internet Protocol: 传输控制&#x2F;网络协议, 网络通讯协议, 包含FTP, SMTP, TCP, UDP等协议簇, TCP和IP最具代表性</li>
<li><code>OSI</code>模型只是一个描述性概念, 描述了应该如何实现, <code>TCP</code>&#x2F;<code>IP</code>协议是实际实现, 包含4层<ul>
<li>应用层: 应用层, 表示层, 会话层</li>
<li>传输层: 传输层</li>
<li>网络层: 网络层</li>
<li>网络接口层: 数据链路层, 物理层</li>
</ul>
</li>
<li>重要协议<ul>
<li>应用层<ul>
<li>HTTP: 超文本传输协议</li>
<li>HTTPS: 加密的超文本传输协议</li>
<li>FTP: 文件传输</li>
<li>DNS: 域名系统</li>
<li>SMTP: 简易邮件传输协议</li>
</ul>
</li>
<li>传输层<ul>
<li>TCP: 传输控制协议</li>
<li>UDP: 用户数据报协议</li>
</ul>
</li>
<li>网络层<ul>
<li>IP协议</li>
</ul>
</li>
</ul>
</li>
<li>TCP协议:<ul>
<li>特点<ul>
<li>必需建立连接</li>
<li>只能一对一</li>
<li>消息发送失败会重新发送, 不允许丢包</li>
<li>有序</li>
</ul>
</li>
<li>三次握手建立连接<ul>
<li>C -&gt; S 发送连接请求, 监听返回消息</li>
<li>S -&gt; C 监听请求, 收到请求, 发送同意回执</li>
<li>C -&gt; S 发送确认状态</li>
<li>之后就可以互相通信</li>
</ul>
</li>
<li>四次挥手<ul>
<li>C -&gt; S 发送断开连接请求, 监听返回消息</li>
<li>S -&gt; C 发送收到, 发送剩余需要发送的数据</li>
<li>S -&gt; C 发送同意断连信息</li>
<li>C -&gt; S 发送等待信息并开始倒计时, 倒计时时间内没有回复就正式断开连接</li>
</ul>
</li>
<li>应用于保证信息准确性的场景: 文件传输, 远程登录等</li>
</ul>
</li>
<li>UDP协议:<ul>
<li>特点<ul>
<li>无需连接</li>
<li>可靠性低, 可能丢失, 丢失后不会重发</li>
<li>传输效率高, 性能消耗小, 处理速度快</li>
<li>n对n</li>
</ul>
</li>
<li>应用于要求实时性的场景: 直播, 语音视频通话等</li>
</ul>
</li>
<li>TCP与UDP的对比<table>
<thead>
<tr>
<th></th>
<th>TCP</th>
<th>UDP</th>
</tr>
</thead>
<tbody><tr>
<td>连接方面</td>
<td>必需先建立连接才能通信</td>
<td>不必连接就可以通讯</td>
</tr>
<tr>
<td>安全方面</td>
<td>无差错, 不丢失, 不重复, 按序到达</td>
<td>只会提交, 不保证到达</td>
</tr>
<tr>
<td>传输效率</td>
<td>相对较低</td>
<td>相对较高</td>
</tr>
<tr>
<td>连接对象</td>
<td>一对一</td>
<td>一对一, 一对多, 多对一, 多对多</td>
</tr>
</tbody></table>
</li>
</ul>
<h2 id="网络通信"><a href="#网络通信" class="headerlink" title="网络通信"></a><a href="#%E7%9B%AE%E5%BD%95">网络通信</a></h2><h3 id="通信前"><a href="#通信前" class="headerlink" title="通信前"></a><a href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1">通信前</a></h3><ul>
<li><code>IPAddress</code>类<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//初始化</span><br>IPAddress ip1 = <span class="hljs-keyword">new</span> IPAddress(<span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[]&#123;<span class="hljs-number">222</span>,<span class="hljs-number">208</span>,<span class="hljs-number">105</span>,<span class="hljs-number">1</span>&#125;); <span class="hljs-comment">//byte[]数组</span><br>IPAddress ip2 = <span class="hljs-keyword">new</span> IPAddress(<span class="hljs-number">0x79666F01</span>); <span class="hljs-comment">//16进制long变量</span><br>IPAddress ip3 = IPAddress.Parse(<span class="hljs-string">&quot;222.208.105.1&quot;</span>); <span class="hljs-comment">//string, 推荐</span><br></code></pre></td></tr></table></figure></li>
<li><code>IPEndPoint</code>类<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//初始化</span><br>IPEndPoint ipPoint = <span class="hljs-keyword">new</span> IPEndPoint(IPAddress.Parse(<span class="hljs-string">&quot;222.208.105.1&quot;</span>),<span class="hljs-number">8080</span>);<br></code></pre></td></tr></table></figure></li>
<li>域名解析<ul>
<li>DNS: 一个将域名与IP地址相互映射的分布式数据库</li>
<li><code>IPHostEntry</code>类<ul>
<li>实例化没有意义, 作为某些方法的返回值使用</li>
<li><code>AddressList</code>: 关联IP</li>
<li><code>HostName</code>: DNS名称</li>
</ul>
</li>
<li><code>Dns</code>静态类<ul>
<li><code>GetHostName()</code>: 本机名</li>
<li><code>Dns.GetHostEntry[Async](&quot;www.baidu.com&quot;)</code><ul>
<li>使用<code>Task</code>声明异步时, 使用<code>task.Result</code>获取结果</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>网络数据的序列化与反序列化: <code>BitConverter</code>类和<code>Encoding</code>类<ul>
<li>常见的字符编码<ul>
<li><code>ASCII</code>(美国), <code>GB2312</code>(中国), <code>Shift_JIS</code>(日本), 世界通用的<code>Unicode</code>及基于此形成的<code>UTF-8</code>,<code>UTF-16</code>,<code>UTF-32</code></li>
<li><code>ASCII</code>使用后7位规定了128个字符, 其他字符基本都是对<code>ASCII</code>的扩充</li>
<li><code>Unicode</code>包含了世界上所有符号, 但只规定了符号和二进制的对应关系, 并没有规定如何存储, <code>UTF-X</code>才是具体的编码方案, <code>UTF-8</code>使用1&#x2F;2&#x2F;3&#x2F;4个字节存储, <code>UTF-16</code>使用2&#x2F;4个字节存储, <code>UTF-32</code>固定使用4个字节存储</li>
</ul>
</li>
<li><code>BitConverter</code>: 除<code>string</code>的其他类型与<code>byte[]</code>互转<ul>
<li>静态方法<code>GetBytes(除string的所有类型)</code></li>
</ul>
</li>
<li><code>Encoding</code>: <code>string</code>转<code>byte[]</code><ul>
<li><code>Encoding.string编码类型.GetBytes(string)</code></li>
</ul>
</li>
<li>序列化与反序列化<ul>
<li>序列化: 计算对象字节数, 创建相应容量的字节数组, <code>CopyTo</code>进去. 普通变量类型的字节长度用<code>sizeof(变量类型)</code>获取, 字符串用<code>Encoding.UTF8.GetBytes(stringName).Length</code>获取</li>
<li>反序列化: 非<code>string</code>类型用<code>BitConverter.To类型(byte数组变量,起始index)</code>, <code>string</code>类型用<code>Encoding.UTF8.GetString(byte数组,起始index,要转的部分的长度int)</code>, 按照<code>Writing()</code>中的顺序依次从获得的<code>byte[]</code>中取出来</li>
<li>序列化数据基类  <figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//序列化数据基类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BaseData</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-built_in">int</span> <span class="hljs-title">GetBytesNum</span>()</span>;<span class="hljs-comment">//返回成员变量的size之和</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">Writing</span>()</span>;<br>    <span class="hljs-comment">//在Writing中声明index和byte[GetBytesNum()], 调用Write函数返回byte[]</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Reading</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes, <span class="hljs-built_in">int</span> beginIndex = <span class="hljs-number">0</span></span>)</span>;<br>    <span class="hljs-comment">//在Reading中begin处读取bytes, 返回这个对象的byte[].Length</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WriteInt</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes,<span class="hljs-built_in">int</span> <span class="hljs-keyword">value</span>,<span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> index</span>)</span><br>    &#123;<br>        BitConverter.GetBytes(<span class="hljs-keyword">value</span>).CopyTo(bytes,index);<br>        index += <span class="hljs-number">4</span>; <span class="hljs-comment">//sizeof(int)</span><br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WriteShort</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes,<span class="hljs-built_in">short</span> <span class="hljs-keyword">value</span>,<span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> index</span>)</span><br>    &#123;<br>        BitConverter.GetBytes(<span class="hljs-keyword">value</span>).CopyTo(bytes,index);<br>        index += <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">short</span>);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WriteLong</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes,<span class="hljs-built_in">long</span> <span class="hljs-keyword">value</span>,<span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> index</span>)</span><br>    &#123;<br>        BitConverter.GetBytes(<span class="hljs-keyword">value</span>).CopyTo(bytes,index);<br>        index += <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">long</span>);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WriteFloat</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes,<span class="hljs-built_in">float</span> <span class="hljs-keyword">value</span>,<span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> index</span>)</span><br>    &#123;<br>        BitConverter.GetBytes(<span class="hljs-keyword">value</span>).CopyTo(bytes,index);<br>        index += <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">float</span>);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WriteByte</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes,<span class="hljs-built_in">byte</span> <span class="hljs-keyword">value</span>,<span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> index</span>)</span><br>    &#123;<br>        BitConverter.GetBytes(<span class="hljs-keyword">value</span>).CopyTo(bytes,index);<br>        index++;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WriteBool</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes,<span class="hljs-built_in">bool</span> <span class="hljs-keyword">value</span>,<span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> index</span>)</span><br>    &#123;<br>        BitConverter.GetBytes(<span class="hljs-keyword">value</span>).CopyTo(bytes,index);<br>        index += <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">bool</span>);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WriteString</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes,<span class="hljs-built_in">string</span> <span class="hljs-keyword">value</span>,<span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> index</span>)</span><br>    &#123;<br>        <span class="hljs-built_in">byte</span>[] valueBytes = Encoding.UTF8.GetBytes(<span class="hljs-keyword">value</span>);<br>        WriteInt(bytes,valueBytes.Length,<span class="hljs-keyword">ref</span> infex);<br>        valueBytes.CopyTo(bytes,index);<br>        index += valueBytes.Length;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">WriteData</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes,BaseData <span class="hljs-keyword">value</span>,<span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> index</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">value</span>.Writing().CopyTo(bytes,index);<br>        index += <span class="hljs-keyword">value</span>.GetBytesNum();<br>    &#125;<br>    <span class="hljs-comment">//反序列化</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-built_in">int</span> <span class="hljs-title">ReadInt</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes,<span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> index</span>)</span><br>    &#123;<br>        <span class="hljs-built_in">int</span> <span class="hljs-keyword">value</span> = BitConverter.ToInt32(bytes,index);<br>        index += <span class="hljs-number">4</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-built_in">short</span> <span class="hljs-title">ReadShort</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes,<span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> index</span>)</span><br>    &#123;<br>        <span class="hljs-built_in">short</span> <span class="hljs-keyword">value</span> = BitConverter.ToInt16(bytes,index);<br>        index += <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">short</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-built_in">long</span> <span class="hljs-title">ReadLong</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes,<span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> index</span>)</span><br>    &#123;<br>        <span class="hljs-built_in">long</span> <span class="hljs-keyword">value</span> = BitConverter.ToInt64(bytes,index);<br>        index += <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">long</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-built_in">float</span> <span class="hljs-title">ReadFloat</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes,<span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> index</span>)</span><br>    &#123;<br>        <span class="hljs-built_in">float</span> <span class="hljs-keyword">value</span> = BitConverter.ToSingle(bytes,index);<br>        index += <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">float</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-built_in">byte</span> <span class="hljs-title">ReadByte</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes,<span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> index</span>)</span><br>    &#123;<br>        <span class="hljs-built_in">byte</span> <span class="hljs-keyword">value</span> = bytes[index];<br>        index += <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">byte</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">ReadBool</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes,<span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> index</span>)</span><br>    &#123;<br>        <span class="hljs-built_in">bool</span> <span class="hljs-keyword">value</span> = BitConverter.ToBoolean(bytes,index);<br>        index += <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">bool</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ReadString</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes,<span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> index</span>)</span><br>    &#123;<br>        <span class="hljs-built_in">int</span> length = BitConverter.ToInt32(bytes,index);<br>        index += <span class="hljs-number">4</span>;<br>        <span class="hljs-built_in">string</span> <span class="hljs-keyword">value</span> = Encoding.UTF8.GetString(bytes,index,length);<br>        index += length;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> T <span class="hljs-title">ReadData</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes, <span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> index</span>) <span class="hljs-keyword">where</span> T:BaseData,<span class="hljs-keyword">new</span>()</span><br>    &#123;<br>        T <span class="hljs-keyword">value</span> = <span class="hljs-keyword">new</span> T();<br>        index += t.Reading(bytes,index);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
  <figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//数据类: 根据成员变量填充基类的抽象方法</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Data</span>:<span class="hljs-title">BaseData</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> age;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> name;<br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> sex;<br>    <span class="hljs-comment">//List就先传List的int长度</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">int</span> <span class="hljs-title">GetBytesNum</span>()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">4</span> + <span class="hljs-comment">/*sizeof(int)*/</span><br>                <span class="hljs-number">4</span> +<span class="hljs-comment">/*sizeof(int)*/</span><br>                Encoding.UTF8.GetBytes(name).Length +<br>                <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">bool</span>);<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">Writing</span>()</span>&#123;<br>        <span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[GetBytesNum()];<br>        WriteInt(bytes,age,<span class="hljs-keyword">ref</span> index);<br>        <span class="hljs-comment">//每一个string前都要对应一个int存length,用于反序列化时提供string的长度</span><br>        WrityeInt(bytes,Encoding.UTF8.GetBytes(name).Length,<span class="hljs-keyword">ref</span> index);<br>        WriteString(bytes,name,<span class="hljs-keyword">ref</span> index);<br>        WriteBool(bytes,<span class="hljs-keyword">ref</span> index);<br>        <span class="hljs-keyword">return</span> bytes;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Reading</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes, <span class="hljs-built_in">int</span> beginIndex = <span class="hljs-number">0</span></span>)</span><br>    &#123;<br>        <span class="hljs-built_in">int</span> index = beginIndex;<br>        <span class="hljs-comment">//按在Writing()中定义的byte[]顺序取出</span><br>        age = ReadInt(bytes,index);<br>        name = ReadString(bytes,index);<br>        sex = ReadBool(bytes,index);<br>        <span class="hljs-keyword">return</span> index - beginIndex;<br>        <span class="hljs-comment">//返回这个对象的byte[].Length, 用于在ReadData()中用于index的自增</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
  <figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//外部使用</span><br><span class="hljs-comment">//序列化为byte[]</span><br>Data data = <span class="hljs-keyword">new</span> Data();<br>data.age = <span class="hljs-number">8</span>;<br>data.name = <span class="hljs-string">&quot;John&quot;</span>;<br>data.sex = <span class="hljs-literal">true</span>;<br><span class="hljs-built_in">byte</span>[] dataBytes = data.Writing();<br><span class="hljs-comment">//完成序列化,获得dataBytes</span><br><span class="hljs-comment">//反序列化</span><br>Data d = <span class="hljs-keyword">new</span> Data();<br>d.Reading(dataBytes);<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="网络游戏通信方案"><a href="#网络游戏通信方案" class="headerlink" title="网络游戏通信方案"></a><a href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1">网络游戏通信方案</a></h3><ul>
<li>弱联网和强联网<blockquote>
<p>弱联网: 不频繁通信, 每次只处理一次请求, 之后就断开连接<br><br>e.g. 开心消消乐等休闲游戏<br><br>强联网: 频繁通信, 一直保持连接状态<br><br>e.g. MMORPG, MOBA, ACT游戏</p>
</blockquote>
</li>
<li>长连接和短连接<blockquote>
<p>短连接: 需要传输数据时连接, 然后断开<br><br>通信方式: HTTP, HTTPS<br><br>长连接: 无论是否需要传输数据, 一直处于连接状态<br><br>通信方式: TCP, UDP</p>
</blockquote>
</li>
<li><code>Socket</code>,<code>HTTP</code>,<code>FTP</code><blockquote>
<p>Socket: 应用层通信字段, 主要用于长连接<br><br>HTTP(S): 简单的请求-响应协议, 通常运行于TCP协议之上, 主要用于短连接和资源下载<br><br>FTP: 用于文件传输, 基于TCP, 用于资源下载和上传</p>
</blockquote>
</li>
</ul>
<h3 id="套接字Socket类"><a href="#套接字Socket类" class="headerlink" title="套接字Socket类"></a><a href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1">套接字<code>Socket</code>类</a></h3><h4 id="常用API"><a href="#常用API" class="headerlink" title="常用API"></a><a href="#%E5%A5%97%E6%8E%A5%E5%AD%97socket%E7%B1%BB">常用<code>API</code></a></h4><ul>
<li>三种类型: 流套接字(TCP用), 数据包套接字(UDP用), 原始套接字(直接访问低层数据, 用于侦听和分析数据包, 不常用)</li>
<li>实例化参数<ul>
<li><code>AddressFamily</code>网络寻址枚举<ul>
<li><code>InterNetwork</code>: <code>IPv4</code></li>
<li><code>InterNetwork6</code>: <code>IPv6</code></li>
</ul>
</li>
<li><code>SocketType0</code>套接字类型枚举<ul>
<li><code>Dgram</code>: 数据报, UDP</li>
<li><code>Stream</code>: 字节流, TCP</li>
</ul>
</li>
<li><code>ProtocolType</code>协议类型枚举<ul>
<li><code>Tcp</code></li>
<li><code>Udp</code></li>
</ul>
</li>
</ul>
</li>
<li>成员属性<ul>
<li>连接状态(<code>bool</code>): <code>Connected</code></li>
<li>准备读取的数据的字节数量(<code>int</code>): <code>Available</code></li>
<li>本机<code>EndPoint</code>对象(<code>as IPEndedPoint</code>): <code>LocalEndedPoint</code></li>
<li>远程<code>EndPoint</code>对象(<code>as IPEndedPoint</code>): <code>RemoteEndedPoint</code></li>
</ul>
</li>
<li>成员方法<blockquote>
<p>服务端</p>
</blockquote>
<ul>
<li>绑定<code>IP</code>和端口号: <code>Bind(IPEndedPoint p)</code></li>
<li>最大连接客户端数量: <code>Listen(int number)</code></li>
<li>等待客户端连接: <code>Accept()</code><blockquote>
<p>客户端</p>
</blockquote>
</li>
<li>连接服务器: <code>Connect()</code><blockquote>
<p>Both</p>
</blockquote>
</li>
<li>同步和异步发送和接收数据: <code>Send[To]()</code>和<code>Receive()</code></li>
<li>关闭: <code>Shutdown(SocketShutdown type)</code></li>
<li>关闭连接: <code>Close()</code></li>
</ul>
</li>
</ul>
<h4 id="通信流程"><a href="#通信流程" class="headerlink" title="通信流程"></a><a href="#%E5%A5%97%E6%8E%A5%E5%AD%97socket%E7%B1%BB">通信流程</a></h4><ul>
<li><code>TCP</code><pre><code class=" Mermaid">stateDiagram
    state Server &#123;
        s1:创建Socket
        s2:用Bind()绑定本地地址
        s3:用Listen()监听
        s4:用Accept()等待用户连接
        s5:建立连接，Accept()返回新Socket
        s6:用Send()和Receive()收发数据
        s7:用Shutdown()释放连接
        s8:关闭Socket
        [*] --&gt; s1
        s1 --&gt; s2
        s2 --&gt; s3
        s3 --&gt; s4
        s4 --&gt; s5
        s5 --&gt; s6
        s6 --&gt; s7
        s7 --&gt; s8
        s8 --&gt; [*]
    &#125;
    state Client &#123;
        c1 : 创建Socket
        c2 : 用Connect()连接服务器
        c3 : 用Send()和Receive()收发数据
        c4 : 用Shutdown()释放连接
        c5 : 关闭Socket
        [*]--&gt;c1
        c1 --&gt; c2
        c2 --&gt; c3
        c3 --&gt; c4
        c4 --&gt; c5
        c5--&gt;[*]
    &#125;
</code></pre></li>
<li><code>UDP</code><pre><code class=" Mermaid">stateDiagram
    state Server &#123;
        s1:创建Socket
        s2:用Bind()绑定本地地址
        s3:用SendTo()和ReceiveFrom()收发数据
        s4:用Shutdown()释放连接
        s5:关闭Socket
        [*] --&gt; s1
        s1 --&gt; s2
        s2 --&gt; s3
        s3 --&gt; s4
        s4 --&gt; s5
        s5 --&gt; [*]
    &#125;
    state Client &#123;
        c1 : 创建Socket
        c2 : 用Bind()绑定本地地址
        c3 : 用SendTo()和ReceiveFrom()收发数据
        c4 : 用Shutdown()释放连接
        c5 : 关闭Socket
        [*]--&gt;c1
        c1 --&gt; c2
        c2 --&gt; c3
        c3 --&gt; c4
        c4 --&gt; c5
        c5--&gt;[*]
    &#125;
</code></pre></li>
</ul>
<h4 id="TCP同步"><a href="#TCP同步" class="headerlink" title="TCP同步"></a><a href="#%E5%A5%97%E6%8E%A5%E5%AD%97socket%E7%B1%BB"><code>TCP</code>同步</a></h4><ul>
<li>服务端: 实例化, 绑定监听等待, 收发消息, 断开关闭<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">static</span> List&lt;Socket&gt; clientSockets = <span class="hljs-keyword">new</span> List&lt;Socket&gt;();<br><span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> isClose = <span class="hljs-literal">false</span>;<br><span class="hljs-comment">//s1:创建Socket</span><br><span class="hljs-keyword">static</span> Socket socketTCP;<br>socketTCP = <span class="hljs-keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocaolType.Tcp);<br><span class="hljs-comment">//s2:用Bind()绑定本地地址</span><br><span class="hljs-keyword">try</span><br>&#123;<br>  IPEndPoint ipPoint = <span class="hljs-keyword">new</span> IPEndPoint(IPAddress.Parse(<span class="hljs-string">&quot;127.0.0.1&quot;</span>), <span class="hljs-number">8080</span>);<br>  socketTCP.Bind(ipPoint);<br>&#125;<br><span class="hljs-keyword">catch</span> (Exception e)<br>&#123;<br>  Console.WriteLine(<span class="hljs-string">&quot;绑定错误: &quot;</span> + e.Message);<br>  <span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-comment">//s3:用Listen()监听</span><br>socketTCP.Listen(<span class="hljs-number">200</span>); <span class="hljs-comment">//最大客户端数量</span><br>Console.WriteLine(<span class="hljs-string">&quot;绑定监听结束, 等待客户端连接&quot;</span>)<br><span class="hljs-comment">//s4:用Accept()等待用户连接 &amp; s5:建立连接，Accept()返回新Socket</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">Socket socketClient = socketTCP.Accept(); //阻塞式代码, 有连入后才能继续往下执行</span><br><span class="hljs-comment">Console.WriteLine(&quot;有客户端连入&quot;);</span><br><span class="hljs-comment">*/</span><br>Thread acceptThread = <span class="hljs-keyword">new</span> Thread(AcceptClient);<br>acceptThread.Start();<br><span class="hljs-comment">/*在外部创建一个静态函数, 用于放在线程中循环接听*/</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AcceptClient</span>()</span><br>&#123;<br>  <span class="hljs-keyword">while</span>(!isClose)&#123;<br>    Socket clientSocket = socketTCP.Accept();<br>    clientSockets.Add(clientSocket);<br>    Console.WriteLine(<span class="hljs-string">&quot;有客户端连入&quot;</span>);<br>    <span class="hljs-comment">//s6:用Send()发数据</span><br>    socketClients.Send(Encoding.UTF8.GetBytes(<span class="hljs-string">&quot;欢迎连入&quot;</span>));<br>  &#125;<br>&#125;<br><span class="hljs-comment">//s6:用Receive()收数据</span><br>Thread rcvMsgThread = <span class="hljs-keyword">new</span> Thread(RcvMsg);<br>rcvMsgThread.Start();<br><span class="hljs-comment">/*外部静态函数*/</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RcvMsg</span>()</span><br>&#123;<br>  <span class="hljs-built_in">byte</span>[] res = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>]; <span class="hljs-comment">//接收byte[]缓存空间</span><br>  Socket clientSocket;<br>  <span class="hljs-built_in">int</span> i; <span class="hljs-comment">//循环i放外部, 减少循环压力</span><br>  <span class="hljs-keyword">while</span>(!isClose)<br>  &#123;<br>    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;clientSockets.Count;i++)&#123;<br>      clientSocket = clientSockets[i];<br>      <span class="hljs-keyword">if</span>(clientSocket.Available &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">int</span> length = socketClient.Receive(res);<br>        <span class="hljs-comment">/*res存放,length获取真正的长度*/</span><br>        <span class="hljs-comment">//使用线程池取线程处理得到的数据, 使用(,)元组传入参数</span><br>        ThreadPool.QueueUserWorkItem(HandleMsg, (clientSocket,Encoding.UTF8.GetString(res,<span class="hljs-number">0</span>,length)));<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br><span class="hljs-comment">/*处理数据逻辑*/</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">HandleMsg</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> obj</span>)</span><br>&#123;<br>  <span class="hljs-comment">//接收元组参数</span><br>  (Socket skt, <span class="hljs-built_in">string</span> str) info = ((Socket skt,<span class="hljs-built_in">string</span> str))obj;<br>  <span class="hljs-comment">//处理info.s和info.str</span><br>&#125;<br><span class="hljs-comment">//s7:用Shutdown()释放连接 &amp; s8:关闭Socket</span><br><span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)<br>&#123;<br>  <span class="hljs-built_in">string</span> input = Console.ReadLine();<br>  <span class="hljs-keyword">if</span>(input == <span class="hljs-string">&quot;quit&quot;</span>)&#123;<br>    isClose = <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> i=<span class="hljs-number">0</span>;i&lt;clientSockets.Count;i++)&#123;<br>      socketClients[i].Shutdown(SocketShutdown.Both);<br>      socketClients[i].Close();<br>    &#125;<br>    clientSockets.Clear();<br>    <span class="hljs-keyword">break</span>;<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(input.Substring(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>)==<span class="hljs-string">&quot;B:&quot;</span>)&#123;<span class="hljs-comment">/*B:发送广播消息*/</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> i=<span class="hljs-number">0</span>;i&lt;clientSockets.Count;i++)&#123;<br>      socketClients[i].Send(Encoding.UTF8.GetBytes(input.Substring(<span class="hljs-number">2</span>)));<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>封装<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ServerSocket</span><br>&#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> isClose;<br>  <span class="hljs-keyword">public</span> Socket socket; <span class="hljs-comment">/*成员Socket*/</span><br>  <span class="hljs-keyword">public</span> Dictionary&lt;<span class="hljs-built_in">int</span>,ClientSocket&gt; clientDic = <span class="hljs-comment">/*所有clients*/</span><br>                          <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">int</span>,ClientSocket&gt;();<br>  <span class="hljs-comment">//待移除, 避免直接移除导致foreach时出问题</span><br>  <span class="hljs-keyword">private</span> List&lt;ClientSocket&gt; delList = <span class="hljs-keyword">new</span> List&lt;ClientSocket&gt;();<br>  <br>  <span class="hljs-comment">//开启</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> ip, <span class="hljs-built_in">int</span> port, <span class="hljs-built_in">int</span> max</span>)</span>&#123;<br>    socket = <span class="hljs-keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);<br>    IPEndPoint ipPoint = <span class="hljs-keyword">new</span> IPEndPoint(IPAddress.Parse(ip),port);<br>    socket.Bind(ipPoint);<br>    socket.Listen(max);<br>    ThreadPool.QueueUserWorkItem(Accept);<br>    ThreadPool.QueueUserWorkItem(Receive);<br>    isClose = <span class="hljs-literal">false</span>;<br>  &#125;<br>  <span class="hljs-comment">//接收连接逻辑</span><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Accept</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> obj</span>)</span>&#123;<br>    <span class="hljs-keyword">while</span>(!isClose)<br>    &#123;<br>      <span class="hljs-keyword">try</span><br>      &#123;<br>        Socket clientSocket = socket.Accept();<br>        ClientSocket client = <span class="hljs-keyword">new</span> ClientSocket(clientSocket);<br>        <span class="hljs-keyword">lock</span>(clientDic)&#123;<br>          clientDic.Add(client.clientID,client);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (Exception e)<br>      &#123;<br>        Console.WriteLine(e.Message);<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">//接收数据逻辑</span><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Receive</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> obj</span>)</span>&#123;<br>    <span class="hljs-keyword">while</span>(!isClose)<br>    &#123;<br>      <span class="hljs-keyword">if</span>(clientDic.Count &gt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">lock</span>(clientDic)&#123;<br>          <span class="hljs-keyword">foreach</span> (ClientSocket c <span class="hljs-keyword">in</span> clientDic.Values)<br>          &#123;<br>            c.Receive();<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">//关闭</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Close</span>()</span>&#123;<br>    isClose = <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">foreach</span> (ClientSocket c <span class="hljs-keyword">in</span> clientDic.Values)<br>    &#123;<br>      c.Close();<br>    &#125;<br>    clientDic.Clear();<br>    socket = <span class="hljs-literal">null</span>;<br>  &#125;<br><br>  <span class="hljs-comment">//广播</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Broadcast</span>(<span class="hljs-params">BaseMsg s</span>)</span>&#123;<br>    <span class="hljs-keyword">lock</span>(clientDic)&#123;<br>      <span class="hljs-keyword">foreach</span> (ClientSocket c <span class="hljs-keyword">in</span> clientDic.Values)&#123;<br>      <span class="hljs-comment">/* 广播的处理逻辑, 待完善</span><br><span class="hljs-comment">      c.Send(s);</span><br><span class="hljs-comment">      */</span><br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">//客户端关闭事件</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CloseClientSocket</span>(<span class="hljs-params">ClientSocket c</span>)</span>&#123;<br>    <span class="hljs-keyword">lock</span>(clientDic)&#123;<br>      c.Close();<br>      <span class="hljs-keyword">if</span>(clientDic.ContainsKey(c.clientID))&#123;<br>        clientDic.Remove(c.clientID);<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">//准备移除ClientSocket</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddDelSocket</span>(<span class="hljs-params">ClientSocket cs</span>)</span>&#123;<br>    <span class="hljs-keyword">if</span>(!delList.Contains(cs))&#123;<br>      delList.Add(cs);<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ClientSocket</span><br>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> CLIENT_ID = <span class="hljs-number">1</span>;<span class="hljs-comment">/*静态ID*/</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> clientID; <span class="hljs-comment">/*成员ID*/</span><br>  <span class="hljs-keyword">public</span> Socket socket; <span class="hljs-comment">/*成员Socket*/</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-built_in">byte</span>[] cacheBytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];<br>  <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> cacheLength = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">//构造函数</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ClientSocket</span>(<span class="hljs-params">Socket s</span>)</span>&#123;<br>    <span class="hljs-keyword">this</span>.clientID = CLIENT_ID;<br>    <span class="hljs-keyword">this</span>.socket = s;<br>    CLIENT_ID++;<br>  &#125;<br><br>  <span class="hljs-comment">//连接状态</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> IsConnected =&gt; <span class="hljs-keyword">this</span>.socket.Connected;<br>  <br>  <span class="hljs-comment">//关闭</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Close</span>()</span>&#123;<br>    <span class="hljs-keyword">if</span>(socket!=<span class="hljs-literal">null</span>)&#123;<br>      socket.Shutdown(SocketShutdown.Both);<br>      socket.Close();<br>      socket = <span class="hljs-literal">null</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">//发送</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Send</span>(<span class="hljs-params">BaseMsg msg</span>)</span>&#123;<br>    <span class="hljs-keyword">if</span>(!IsConnected)&#123;<span class="hljs-keyword">return</span>;&#125;<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>      socket?.Send(msg.Writing());<br>    &#125;<br>    <span class="hljs-keyword">catch</span>(Exception e)<br>    &#123;<br>      Console.WriteLine(e.message);<br>      Close();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">//接收</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Receive</span>()</span>&#123;<br>    <span class="hljs-keyword">if</span>(!IsConnected)&#123;<span class="hljs-keyword">return</span>;&#125;<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>      <span class="hljs-keyword">if</span>(socket.Available &gt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">byte</span>[] res = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">5</span>];<br>        <span class="hljs-built_in">int</span> length = socketClient.Receive(res);<br>        HandleRcvMsg(res,length);<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        int msgID = BitConverter.ToInt32(res,0);</span><br><span class="hljs-comment">        BaseMsg msg = null;</span><br><span class="hljs-comment">        switch(msgID)</span><br><span class="hljs-comment">        &#123;</span><br><span class="hljs-comment">          case 1001:</span><br><span class="hljs-comment">            msg = new PlayerInfo();</span><br><span class="hljs-comment">            msg.Reading(res,4);</span><br><span class="hljs-comment">            break;</span><br><span class="hljs-comment">        &#125;</span><br><span class="hljs-comment">        if(msg==nul)&#123; return;&#125;</span><br><span class="hljs-comment">        ThreadPool.QueueUserWorkItem(HandleMsg,msg);</span><br><span class="hljs-comment">        */</span><br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Exception e)<br>    &#123;<br>      Console.WriteLine(e.Message);<br>      Close();<br>    &#125;<br>  &#125;<br>  <span class="hljs-comment">//接收数据后处理逻辑</span><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">HandleMsg</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> obj</span>)</span><br>  &#123;<br>    BaseMsg m = obj <span class="hljs-keyword">as</span> BaseMsg;<br>    <span class="hljs-keyword">if</span>(m <span class="hljs-keyword">is</span> PlayerInfo)&#123;<br>      PlayerInfo pl = m <span class="hljs-keyword">as</span> PlayerInfo;<br>      <span class="hljs-comment">/*接收到PlayerInfo数据的逻辑*/</span><br>    &#125;<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">HandleRcvMsg</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes, <span class="hljs-built_in">int</span> len</span>)</span><br>  &#123;<br>    <span class="hljs-built_in">int</span> msgID = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">int</span> msgLength = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">int</span> nowIndex = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">//拼接</span><br>    bytes.CopyTo(cacheBytes,cacheLength);<br>    cacheLength += len;<br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)<br>    &#123;<br>      msgLength = <span class="hljs-number">-1</span>;<br>      <span class="hljs-keyword">if</span>(cacheLength - nowIndex &gt;= <span class="hljs-number">8</span>)&#123;<br>        <span class="hljs-comment">//解析ID</span><br>        msgID = BitConverter.ToInt32(cacheBytes, nowIndex);<br>        nowIndex += <span class="hljs-number">4</span>;<br>        <span class="hljs-comment">//解析长度</span><br>        msgLength = BitConverter.ToInt32(cacheBytes, nowIndex);<br>        nowIndex += <span class="hljs-number">4</span>;<br>      &#125;<br><br>      <span class="hljs-keyword">if</span>(cacheLength - nowIndex &gt;= msgLength &amp;&amp; msgLength != <span class="hljs-number">-1</span>)&#123;<br>        <span class="hljs-comment">/*保证进去时上一段代码已经执行, 避免上一次的数据影响下次*/</span><br>        <span class="hljs-comment">//解析数据</span><br>        BaseMsg baseMsg = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">switch</span>(msgID)<br>        &#123;<br>          <span class="hljs-keyword">case</span> <span class="hljs-number">1001</span>:<br>            PlayerInfo pl = <span class="hljs-keyword">new</span> PlayerInfo();<br>            pl.Reading(cacheBytes,nowIndex);<br>            baseMsg = pl;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(baseMsg!=<span class="hljs-literal">null</span>)&#123;<br>          ThreadPool.QueueUserWorkItem(HandleMsg,msg);<br>        &#125;<br>        nowIndex += len;<br>        <span class="hljs-keyword">if</span>(nowIndex==cacheLength)&#123;<br>          cacheLength = <span class="hljs-number">0</span>;<br>          <span class="hljs-keyword">break</span>;<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">if</span>(len != <span class="hljs-number">-1</span>)&#123;<br>          nowIndex -= <span class="hljs-number">8</span>;<br>          Array.Copy(cacheBytes, nowIndex, cacheBytes, <span class="hljs-number">0</span>, len - nowIndex);<br>          cacheLength -= nowIndex;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>外部使用<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs C#">ServerSocket s = <span class="hljs-keyword">new</span> ServerSocket();<br>s.Start(<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<span class="hljs-number">8080</span>,<span class="hljs-number">5</span>);<br>Console.WriteLine(<span class="hljs-string">&quot;服务器开启成功&quot;</span>);<br><span class="hljs-keyword">while</span>(!s.isClose)&#123;<br>  <span class="hljs-built_in">string</span> <span class="hljs-keyword">in</span> = Console.ReadLine();<br>  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">in</span> == <span class="hljs-string">&quot;quit&quot;</span>)&#123;<br>    s.Close();<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">in</span>.Substring(<span class="hljs-number">0</span>,<span class="hljs-number">2</span>)==<span class="hljs-string">&quot;B:&quot;</span>)&#123;<br>    <span class="hljs-comment">/* 广播处理逻辑, 待完善, 可以声明一个继承BaseMsg的广播消息类发送</span><br><span class="hljs-comment">    s.Broadcast(in.Substring(2));</span><br><span class="hljs-comment">    */</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li>客户端: 实例化, 连接, 收发消息, 断开关闭<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//c1 : 创建Socket</span><br>Socket socketTCP = <span class="hljs-keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocaolType.Tcp);<br><span class="hljs-comment">//c2 : 用Connect()连接服务器</span><br>IPEndPoint ipPoint = <span class="hljs-keyword">new</span> IPEndPoint(IPAddress.Parse(<span class="hljs-string">&quot;127.0.0.1&quot;</span>), <span class="hljs-number">8080</span> );<br><span class="hljs-keyword">try</span><br>&#123;<br>  socketTCP.Connect(ipPoint);<br>&#125;<br><span class="hljs-keyword">catch</span> (SocketException e)<br>&#123;<br>  <span class="hljs-keyword">if</span>(e.ErrorCode == <span class="hljs-number">10061</span>)&#123;<br>      Console.WriteLine(<span class="hljs-string">&quot;服务器拒绝连接&quot;</span>);<br>  &#125; <span class="hljs-keyword">else</span>&#123;<br>      Console.WriteLine(<span class="hljs-string">&quot;连接失败: &quot;</span> + e.ErrorCode);<br>  &#125;<br>  <span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-comment">//c3 : 用Send()和Receive()收发数据</span><br><span class="hljs-built_in">byte</span>[] res = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>];<br><span class="hljs-built_in">int</span> length = socketTCP.Receive(res);<br>Console.WriteLine(<span class="hljs-string">&quot;服务器消息: &quot;</span> + Encoding.UTF8.GetString(res,<span class="hljs-number">0</span>,length));<br>socketTCP.Send(Encoding.UTF8.GetBytes(<span class="hljs-string">&quot;这里是客户端&quot;</span>));<br><span class="hljs-comment">//c4 : 用Shutdown()释放连接</span><br>socketTCP.Shutdown(SocketShutdown.Both);<br><span class="hljs-comment">//c5 : 关闭Socket</span><br>socketTCP.Close();<br></code></pre></td></tr></table></figure>
<ul>
<li>Mono单例模式: 客户端网络通信管理器<code>NetMgr</code><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NetMgr</span> : <span class="hljs-title">MonoBehavior</span><br>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> NetMgr instance;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NetMgr Instance =&gt; instance;<br>  <span class="hljs-keyword">private</span> Socket socket;<br>  <span class="hljs-keyword">private</span> Queue&lt;BaseMsg&gt; sendMsgQueue = <span class="hljs-keyword">new</span> Queue&lt;BaseMsg&gt;();<br>  <span class="hljs-comment">/*用于发送消息的容器队列 主线程存 发送线程取*/</span><br>  <span class="hljs-keyword">private</span> Queue&lt;BaseMsg&gt; rcvMsgQueue = <span class="hljs-keyword">new</span> Queue&lt;BaseMsg&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-built_in">byte</span>[] cacheBytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>]; <span class="hljs-comment">//分包暂存用</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> cacheLength = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> isConnected = <span class="hljs-literal">false</span>;<br><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span><br>  &#123;<br>    instance = <span class="hljs-keyword">this</span>;<br>    DontDestroyOnLoad(<span class="hljs-keyword">this</span>.gameObject);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>()</span><br>  &#123;<br>    <span class="hljs-keyword">if</span>(rcvMsgQueue.Count &gt; <span class="hljs-number">0</span>)&#123;<br>      BaseMsg msg = rcvMsgQueue.Dequeue();<br>      <span class="hljs-keyword">if</span>(msg <span class="hljs-keyword">is</span> PlayerInfo)&#123;<br>        PlayerInfo pl = msg <span class="hljs-keyword">as</span> PlayerInfo;<br>        <span class="hljs-comment">/*pl逻辑*/</span><br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnDestroy</span>()</span><br>  &#123;<br>    Close();<br>  &#125;<br><br>  <span class="hljs-comment">//连接</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Connect</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> ip, <span class="hljs-built_in">int</span> port</span>)</span><br>  &#123;<br>    <span class="hljs-keyword">if</span>(isConnected)&#123; <span class="hljs-keyword">return</span>;&#125;<br>    <span class="hljs-keyword">if</span>(socket == <span class="hljs-literal">null</span>)&#123;<br>      socket = <span class="hljs-keyword">new</span> Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocaolType.Tcp);<br>    &#125;<br>    IPEndPoint ipPoint = <span class="hljs-keyword">new</span> IPEndPoint(IPAddress.Parse(ip),port);<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>      socket.Connect(ipPoint);<br>      ThreadPool.QueueUserWorkItem(SendMsg);<br>      ThreadPool.QueueUserWorkItem(ReceiveMsg);<br>      isConnected = <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (SocketException e)<br>    &#123;<br>      isConnected = <span class="hljs-literal">false</span>;<br>      <span class="hljs-keyword">if</span>(e.ErrorCode == <span class="hljs-number">10061</span>)&#123;<br>          Console.WriteLine(<span class="hljs-string">&quot;服务器拒绝连接&quot;</span>);<br>      &#125; <span class="hljs-keyword">else</span>&#123;<br>          Console.WriteLine(<span class="hljs-string">&quot;连接失败: &quot;</span> + e.ErrorCode);<br>      &#125;<br>    &#125;        <br>  &#125;<br><br>  <span class="hljs-comment">//发送数据</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Send</span>(<span class="hljs-params">BaseMsg m</span>)</span><br>  &#123;<br>    sendMsgQueue.Enqueue(m);<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendMsg</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> obj</span>)</span><br>  &#123;<br>    <span class="hljs-keyword">while</span>(isConnected)<br>    &#123;<br>      <span class="hljs-keyword">if</span>(sendMsgQueue.Count &gt; <span class="hljs-number">0</span>)&#123;<br>        socket?.Send(sendMsgQueue.Dequeue().Writing());<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">//接收数据</span><br>  <span class="hljs-comment">/*这里接收的数据在rcvMsgQueue中, 在Update中监听收取*/</span><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ReceiveMsg</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> obj</span>)</span><br>  &#123;<br>    <span class="hljs-keyword">while</span>(isConnected)<br>    &#123;<br>      <span class="hljs-keyword">if</span>(socket.Available &gt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">byte</span>[] rcvBytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];<br>        <span class="hljs-built_in">int</span> rcvLength = socket.Receive(rcvBytes);<br>        HandleRcvMsg(rcvBytes,rcvLength); <span class="hljs-comment">//分包黏包判断</span><br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">HandleRcvMsg</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes, <span class="hljs-built_in">int</span> len</span>) <span class="hljs-comment">//分包黏包判断</span></span><br>  &#123;<br>    <span class="hljs-built_in">int</span> msgID = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">int</span> msgLength = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">int</span> nowIndex = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">//拼接</span><br>    bytes.CopyTo(cacheBytes,cacheLength);<br>    cacheLength += len;<br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)<br>    &#123;<br>      msgLength = <span class="hljs-number">-1</span>;<br>      <span class="hljs-keyword">if</span>(cacheLength - nowIndex &gt;= <span class="hljs-number">8</span>)&#123;<br>        <span class="hljs-comment">//解析ID</span><br>        msgID = BitConverter.ToInt32(cacheBytes, nowIndex);<br>        nowIndex += <span class="hljs-number">4</span>;<br>        <span class="hljs-comment">//解析长度</span><br>        msgLength = BitConverter.ToInt32(cacheBytes, nowIndex);<br>        nowIndex += <span class="hljs-number">4</span>;<br>      &#125;<br><br>      <span class="hljs-keyword">if</span>(cacheLength - nowIndex &gt;= msgLength &amp;&amp; msgLength != <span class="hljs-number">-1</span>)&#123;<br>        <span class="hljs-comment">/*保证进去时上一段代码已经执行, 避免上一次的数据影响下次*/</span><br>        <span class="hljs-comment">//解析数据</span><br>        BaseMsg baseMsg = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">switch</span>(msgID)<br>        &#123;<br>          <span class="hljs-keyword">case</span> <span class="hljs-number">1001</span>:<br>            PlayerInfo pl = <span class="hljs-keyword">new</span> PlayerInfo();<br>            pl.Reading(cacheBytes,nowIndex);<br>            baseMsg = pl;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(baseMsg!=<span class="hljs-literal">null</span>)&#123; rcvQueue.Enqueue(baseMsg);&#125;<br>        nowIndex += len;<br>        <span class="hljs-keyword">if</span>(nowIndex==cacheLength)&#123;<br>          cacheLength = <span class="hljs-number">0</span>;<br>          <span class="hljs-keyword">break</span>;<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span>&#123; <span class="hljs-comment">//分包</span><br>        <span class="hljs-comment">//如果解析了头部而不解析数据, 则nowIndex - 8并重新存</span><br>        <span class="hljs-keyword">if</span>(len != <span class="hljs-number">-1</span>)&#123;<br>          nowIndex -= <span class="hljs-number">8</span>;<br>          Array.Copy(cacheBytes, nowIndex, cacheBytes, <span class="hljs-number">0</span>, len - nowIndex);<br>          cacheLength -= nowIndex;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">//关闭</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Close</span>()</span><br>  &#123;<br>    isConnected = <span class="hljs-literal">false</span>;<br>    socket?.Shutdown(SocketShutdowm.Both);<br>    socket?.Disconnect(<span class="hljs-literal">false</span>);<br>    socket?.Close();<br>    socket = <span class="hljs-literal">null</span>;<br>    isConnected = <span class="hljs-literal">false</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>外部使用: 在游戏<code>Main</code>方法的<code>Start()</code>中为其专门创建一个GO使用<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>()</span><br>&#123;<br>  <span class="hljs-comment">//为NetMgr初始化一个GO    </span><br>  <span class="hljs-keyword">if</span>(NetMgr.Instance == <span class="hljs-literal">null</span>)&#123;<br>    GameObject netmgr = <span class="hljs-keyword">new</span> GameObject(<span class="hljs-string">&quot;netmgr&quot;</span>);<br>    netmgr.AddComponent&lt;NetMgr&gt;();<br>  &#125;<br>  <br>  <span class="hljs-comment">//然后可以连接和发送消息</span><br>  NetMgr.Instance.Connect(<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<span class="hljs-number">8080</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li>区分消息类型<blockquote>
<p>获取到的字节数组如何区分是什么类 &gt; 在消息头部添加消息ID用于识别</p>
</blockquote>
<ul>
<li>创建继承<code>BaseData</code>的消息基类<code>BaseMsg</code><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BaseMsg</span>:<span class="hljs-title">BaseData</span><br>&#123;<br>  <span class="hljs-comment">/*三个override*/</span><br><br>  <span class="hljs-comment">//子类重写</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-built_in">int</span> <span class="hljs-title">GetID</span>()</span>&#123; <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>消息数据类<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PlayerInfo</span>:<span class="hljs-title">BaseMsg</span><br>&#123;<br>  <span class="hljs-built_in">string</span> name;<br>  <span class="hljs-built_in">int</span> age;<br>  <br>  <span class="hljs-comment">//四个override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">int</span> <span class="hljs-title">GetBytesNum</span>()</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">4</span> + <span class="hljs-comment">/*消息ID的int*/</span><br>            <span class="hljs-number">4</span> + <span class="hljs-comment">/*用于存储消息长度, 以检验分包和黏包*/</span><br>            <span class="hljs-number">4</span> + <span class="hljs-comment">/*string前的int*/</span><br>            Encoding.UTF8.GetBytes(name).Length +<br>            <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">bool</span>) <span class="hljs-comment">/*age的int*/</span>;<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">Writing</span>()</span>&#123;<br>    <span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>,bytesnum = GetBytesNum();<br>    <span class="hljs-built_in">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[bytesnum];<br>    WriteInt(bytes,GetID(),<span class="hljs-keyword">ref</span> index); <span class="hljs-comment">//消息ID的位置</span><br>    WriteInt(bytes,bytesnum - <span class="hljs-number">8</span>, <span class="hljs-keyword">ref</span> index); <span class="hljs-comment">//消息的长度</span><br>    WrityeInt(bytes,Encoding.UTF8.GetBytes(name).Length,<span class="hljs-keyword">ref</span> index);<br>    WriteString(bytes,name,<span class="hljs-keyword">ref</span> index);<br>    WriteInt(bytes,age,<span class="hljs-keyword">ref</span> index);<br>    <span class="hljs-keyword">return</span> bytes;<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Reading</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes, <span class="hljs-built_in">int</span> beginIndex = <span class="hljs-number">0</span></span>)</span><br>  &#123;<br>    <span class="hljs-built_in">int</span> index = beginIndex;<br>    <span class="hljs-comment">//识别消息ID应在Reading之前, Reading专门处理数据问题</span><br>    name = ReadString(bytes,index);<br>    age = ReadInt(bytes,index);<br>    <span class="hljs-keyword">return</span> index - beginIndex;<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">int</span> <span class="hljs-title">GetID</span>()</span><br>  &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1001</span>; <span class="hljs-comment">//自定义标识ID, 也可以返回short,long</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><code>Socket</code>接收消息前<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-built_in">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>]; <span class="hljs-comment">//临时byte[]</span><br><span class="hljs-built_in">int</span> rcvLength = socket.Receive(bytes); <span class="hljs-comment">//真实长度</span><br><span class="hljs-built_in">int</span> msgID = BitConverter.ToInt32(bytes,<span class="hljs-number">0</span>); <span class="hljs-comment">//获得消息ID</span><br><span class="hljs-keyword">switch</span>(msgID) <span class="hljs-comment">//消息ID识别分支</span><br>&#123;<br>  <span class="hljs-keyword">case</span> <span class="hljs-number">1001</span>:<br>    PlayerInfo pi = <span class="hljs-keyword">new</span> PlayerInfo();<br>    pi.Reading(bytes,<span class="hljs-number">4</span>);<br>    <span class="hljs-keyword">break</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li>分包和黏包<blockquote>
<p>分包: 一个消息被分成了多个消息进行发送;<br>黏包: 一个消息和另一个消息黏在了一起<br>( 以上两者可能同时发生 )<br>解决思路: 加一个长度头部, 根据长度判断是否完整&#x2F;分包&#x2F;黏包</p>
</blockquote>
</li>
<li>心跳消息: 长连接游戏中, 客户端按时不断发消息, 服务端一直检测消息<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//消息类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HeartMsg</span>:<span class="hljs-title">BaseMsg</span><br>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">int</span> <span class="hljs-title">GetBytesNum</span>()</span><br>  &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">8</span>; <span class="hljs-comment">//不需要内容, 只需要头部ID和Length</span><br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">Writing</span>()</span><br>  &#123;<br>    <span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[GetBytesNum()];<br>    WriteInt(bytes,GetID(),<span class="hljs-keyword">ref</span> index);<br>    WriteInt(bytes,<span class="hljs-number">0</span>,<span class="hljs-keyword">ref</span> index);<br>    <span class="hljs-keyword">return</span> bytes;<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Reading</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes, <span class="hljs-built_in">int</span> beginIndex = <span class="hljs-number">0</span></span>)</span><br>  &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">int</span> <span class="hljs-title">GetID</span>()</span><br>  &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">999</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//NetMgr类</span><br><span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> HEART_MSG_TIME = <span class="hljs-number">2</span>;<br><span class="hljs-keyword">private</span> HeartMsg heartMsg = <span class="hljs-keyword">new</span> HeartMsg();<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span><br>&#123;<br>  InvokeRepeating(<span class="hljs-string">&quot;SendHeartMsg&quot;</span>,<span class="hljs-number">0</span>,HEART_MSG_TIME);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendHeartMsg</span>()</span><br>&#123;<br>  <span class="hljs-keyword">if</span>(isConnected)&#123;<br>    Send(heartMsg);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//ClientSocket</span><br><span class="hljs-keyword">private</span> <span class="hljs-built_in">long</span> crtTime = <span class="hljs-number">-1</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TIME_OUT_TIME = <span class="hljs-number">10</span>;<br><span class="hljs-comment">//收到消息的switch</span><br>  <span class="hljs-keyword">case</span> <span class="hljs-number">999</span>: <span class="hljs-keyword">break</span>;<br><span class="hljs-comment">//Handle消息</span><br>  crtTime = DataTime.Now.Ticks / TimeSpan.TicksPerSecond;<br>  <span class="hljs-comment">/*更新时间*/</span><br><span class="hljs-comment">//检查是否超时的函数</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CheckTimeOut</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> obj</span>)</span><br>&#123;<br>  <span class="hljs-keyword">if</span>(crtTime != <span class="hljs-number">-1</span> &amp;&amp; <br>  DataTime.Now.Ticks / TimeSpan.TicksPerSecond &gt;= TIME_OUT_TIME)<br>  &#123;<br>    <span class="hljs-keyword">this</span>.AddDelList(<span class="hljs-keyword">this</span>);<br>  &#125;<br>&#125;<br><span class="hljs-comment">//在Receive函数中添加该函数</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="TCP异步"><a href="#TCP异步" class="headerlink" title="TCP异步"></a><a href="#%E5%A5%97%E6%8E%A5%E5%AD%97socket%E7%B1%BB"><code>TCP</code>异步</a></h4><ul>
<li>异步原理<ul>
<li>线程回调<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//Async</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CountAsync</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> second, Action callback</span>)</span><br>&#123;<br>  Thread t = <span class="hljs-keyword">new</span> t(() = &#123;<br>    <span class="hljs-keyword">while</span>(second&gt;<span class="hljs-number">0</span>)&#123;<br>      Console.WriteLine(second);<br>      Thread.Sleep(<span class="hljs-number">1000</span>);<br>      second--;<br>    &#125;<br>    callback?.Invoke();<br>  &#125;);<br>  t.Start();<br>&#125;<br><br><span class="hljs-comment">//调用</span><br>CountAsync(<span class="hljs-number">3</span>,() = &#123;<br>  Console.WriteLine(<span class="hljs-string">&quot;结束&quot;</span>);<br>&#125;);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">3</span><br><span class="hljs-comment">2</span><br><span class="hljs-comment">1</span><br><span class="hljs-comment">结束</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure></li>
<li>分步执行, <code>await</code>时返回出去, 执行完毕后继续<code>await</code>后面的<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//async</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CountAsync</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> second</span>)</span><br>&#123;<br>  <span class="hljs-keyword">await</span> Task.Run(() =&gt; &#123;<br>    <span class="hljs-keyword">while</span>(second&gt;<span class="hljs-number">0</span>)&#123;<br>      Console.WriteLine(second);<br>      Thread.Sleep(<span class="hljs-number">1000</span>);<br>      second--;<br>    &#125;<br>  &#125;);<br>  Console.WriteLine(<span class="hljs-string">&quot;结束&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">//调用</span><br>CountAsync(<span class="hljs-number">3</span>);<br>Console.WriteLine(<span class="hljs-string">&quot;a&quot;</span>);<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">3</span><br><span class="hljs-comment">a</span><br><span class="hljs-comment">2</span><br><span class="hljs-comment">1</span><br><span class="hljs-comment">结束</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><code>Socket</code> <code>TCP</code>中的异步方法(<code>Begin</code>与<code>End</code>)<ul>
<li>函数参数<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//回调函数参数IAsyncResult</span><br><span class="hljs-comment">//AsyncState调用异步方法时传入的参数</span><br><span class="hljs-comment">//AsyncWaitHandle同步等待</span><br></code></pre></td></tr></table></figure></li>
<li>服务器<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//1. 接收连接</span><br>Socket socketTCP = <span class="hljs-keyword">new</span> Socket(..,..,..);<br>socketTCP.BeginAccpet(BeginBeginAccept(res),socketTCP);<br><span class="hljs-comment">/*res -&gt; IAsyncResult*/</span><br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">BeginBeginAccept</span>(<span class="hljs-params">IAsyncResult res</span>)</span><br>&#123;<br>  <span class="hljs-keyword">try</span><br>  &#123;<br>    Socket s = res.AsyncState <span class="hljs-keyword">as</span> Socket;<br>    <span class="hljs-comment">/*res.AsyncState -&gt; BeginAccept的第二个参数*/</span><br>    Socket clientSocket = s.EndAccpet(res);<br>    <span class="hljs-comment">/*EndSocket返回值为客户端Socket*/</span><br>    s.BeginAccept(res,s);<br>    <span class="hljs-comment">/*这里不算递归*/</span><br>  &#125;<br>  <span class="hljs-keyword">catch</span> (SocketException e)<br>  &#123;<br>    print(e.SocketErrorCode);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">//2. 接收消息</span><br>BeginReceive(存储数组, index, 数组长度, 标识枚举, 回调函数, AsyncState)<br></code></pre></td></tr></table></figure></li>
<li>客户端<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//1. 开始连接</span><br>IPEndPoint ipPoint = <span class="hljs-keyword">new</span> (IPAddress.Parse(<span class="hljs-string">&quot;localhost&quot;</span>),<span class="hljs-number">8080</span>);<br>Socket socketTCP = <span class="hljs-keyword">new</span> Socket(..,..,..);<br>socketTCP.BeginConnect(ipPoint,(res)=&gt;&#123;<br>  Socket s = res.AsyncState <span class="hljs-keyword">as</span> Socket;<br>  <span class="hljs-keyword">try</span><br>  &#123;<br>    s.EndConnect(res);<br>    <span class="hljs-comment">//连接成功</span><br>  &#125;<br>  <span class="hljs-keyword">catch</span> (SocketException e)<br>  &#123;<br>    <span class="hljs-comment">//连接失败</span><br>  &#125;<br>&#125;,socketTCP);<br><br><span class="hljs-comment">//2. 发送消息</span><br>BeginSend(数组, 标识, 回调, AsyncState)<br></code></pre></td></tr></table></figure></li>
<li>封装<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//服务端</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ClientSocket</span><br>&#123;<br>  <span class="hljs-keyword">public</span> Socket socket;<br>  <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> clientID;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> CLIENT_BEGIN_ID = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-built_in">byte</span>[] cacheBytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>];<br>  <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> cacheNum = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ClientSocket</span>(<span class="hljs-params">Socket socket</span>)</span>&#123;<br>    clientID = CLIENT_BEGIN_ID++;<br>    <span class="hljs-keyword">this</span>.socket = socket;<br><br>    <span class="hljs-keyword">this</span>.socket.BeginReceive(cacheBytes, cacheNum, <br>                            cacheBytes.Length, SocketFlags.None, <br>                            ReceiveCallback, <span class="hljs-literal">null</span>);<br>  &#125;<br>  <br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ReceiveCallback</span>(<span class="hljs-params">IAsyncResult res</span>)</span><br>  &#123;<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>      cacheNum = <span class="hljs-keyword">this</span>.socket.EndReceive(res);<br>      <span class="hljs-comment">/*处理逻辑*/</span><br>      cacheNum = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.socket.Connected)&#123;<br>        <span class="hljs-keyword">this</span>.socket.BeginReceive(cacheBytes, cacheNum, <br>                            cacheBytes.Length, SocketFlags.None, <br>                            ReceiveCallback, <span class="hljs-literal">null</span>);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (SocketException e)<br>    &#123;<br>      Debug.log(e.SocketErrorCode + e.Message);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Send</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> s</span>)</span><br>  &#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.socket.Connected)&#123;<br>      <span class="hljs-built_in">byte</span>[] bytes = Encoding.UTF8.GetBytes(s);<br>      <span class="hljs-keyword">this</span>.socket.BeginSend(bytes, <span class="hljs-number">0</span>, bytes.Length, SocketFlags.None, SendCallback, <span class="hljs-literal">null</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendCallback</span>(<span class="hljs-params">IAsyncResult res</span>)</span><br>  &#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.socket.Connected)&#123;<br>      <span class="hljs-keyword">try</span><br>      &#123;<br>        <span class="hljs-keyword">this</span>.socket.EndSend(res);<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (SocketException e)<br>      &#123;<br>        Debug.log(e.SocketErrorCode + e.Message);<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ServerSocket</span><br>&#123;<br>  <span class="hljs-keyword">public</span> Socket socket;<br>  <span class="hljs-keyword">private</span> Dictionary&lt;<span class="hljs-built_in">int</span>,ClientSocket&gt; clientDic = <span class="hljs-keyword">new</span> ();<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> ip, <span class="hljs-built_in">int</span> port, <span class="hljs-built_in">int</span> num</span>)</span>&#123;<br>    socket = <span class="hljs-keyword">new</span> (..,..,..);<br>    IPPoint ipPoint = <span class="hljs-keyword">new</span> (IPAddress.Parse(<span class="hljs-string">&quot;217.0.0.1&quot;</span>),<span class="hljs-number">8080</span>);<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>      socket.Bind(ipPoint);<br>      socket.Listen(num);<br>      socket.BeginAccept(AcceptCallback,<span class="hljs-literal">null</span>);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Exception e)<br>    &#123;<br>      Debug.log(e.Message);<br>    &#125;<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AcceptCallback</span>(<span class="hljs-params">IAsyncResult res</span>)</span><br>  &#123;<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>      ClientSocket client = <span class="hljs-keyword">new</span> (socket.EndAccept(res));<br>      clientDic.Add(client.ID,client);<br>      socket.BeginAccept(AcceptCallback,<span class="hljs-literal">null</span>);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (SocketException e)<br>    &#123;<br>      Debug.log(e.SocketErrorCode + e.Message);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//客户端</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NetAsyncMgr</span> : <span class="hljs-title">MonoBehaviour</span><br>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> NetAsyncMgr instance;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Instance =&gt; instance;<br>  <span class="hljs-keyword">private</span> Socket socket;<br>  <span class="hljs-keyword">private</span> <span class="hljs-built_in">byte</span>[] cacheBytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>];<br>  <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> byteNum = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span><br>  &#123;<br>    instance = <span class="hljs-keyword">this</span>;<br>    DontDestroyOnLoad(<span class="hljs-keyword">this</span>.gameObject);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Connect</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> ip, <span class="hljs-built_in">int</span> port</span>)</span><br>  &#123;<br>    <span class="hljs-keyword">if</span>(socket != <span class="hljs-literal">null</span> &amp;&amp; socket.Connected)&#123; <span class="hljs-keyword">return</span>;&#125;<br>    IPPoint ipPoint = <span class="hljs-keyword">new</span> (IPAddress.Parse(ip),port);<br>    socket = <span class="hljs-keyword">new</span> Socket(..,..,..);<br>    SocketAsyncEventArgs args = <span class="hljs-keyword">new</span> ();<br>    args.RemoteEndPoint = ipPoint;<br>    args.Completed += ((socket,args) =&gt; &#123;<br>      <span class="hljs-keyword">if</span>(args.SocketError = SocketError.Success)&#123;<br>        <span class="hljs-comment">//连接成功</span><br>        SocketAsyncEventArgs rcvArgs = <span class="hljs-keyword">new</span> ();<br>        rcvArgs.SetBuffer(cacheBytes,<span class="hljs-number">0</span>,cacheNum);<br>        rcvArgs.Completed += RcvCallback;<br>        <span class="hljs-keyword">this</span>.socket.ReceiveAsync(rcvArgs);<br>      &#125;<span class="hljs-keyword">else</span>&#123;<br>        Debug.log(args.SocketError);<br>      &#125;<br>    &#125;);<br>    socket.ConnectAsync(args);<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RcvCallback</span>(<span class="hljs-params">Object obj, SocketAsyncEventArgs args</span>)</span><br>  &#123;<br>    <span class="hljs-keyword">if</span>(args.SocketError = SocketError.Success)&#123;<br>        <span class="hljs-comment">//连接成功</span><br>        <span class="hljs-comment">//args.Buffer </span><br>        <span class="hljs-comment">//args.BytesTransferred</span><br>        rcvArgs.SetBuffer(<span class="hljs-number">0</span>,args.Buffer.Length);<br>        <span class="hljs-keyword">this</span>.socket.ReceiveAsync(args);<br>      &#125;<span class="hljs-keyword">else</span>&#123;<br>        Debug.log(args.SocketError);<br>      &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Close</span>()</span><br>  &#123;<br>    <span class="hljs-keyword">if</span>(socket != <span class="hljs-literal">null</span>)&#123;<br>      socket.Shutdown(SocketShutdown.Both);<br>      socket.DisConnect(<span class="hljs-literal">false</span>);<br>      socket.Close();<br>      socket = <span class="hljs-literal">null</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Send</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> s</span>)</span><br>  &#123;<br>    <span class="hljs-built_in">byte</span>[] bytes = Encoding.UTF8.GetBytes(s);<br>    SocketAsyncEventArgs rcvArgs = <span class="hljs-keyword">new</span> ();<br>        rcvArgs.SetBuffer(cacheBytes,<span class="hljs-number">0</span>,cacheNum);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><code>Socket</code> <code>TCP</code>中的异步方法(<code>Async</code>)(.Net 3.5)<ul>
<li>传入参数<code>SocketAsyncEventArgs</code></li>
<li>服务端<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs C#">Socket socketTCP = <span class="hljs-keyword">new</span> (..,..,.<span class="hljs-number">.0</span>);<br>SocketAsyncEventArgs e = <span class="hljs-keyword">new</span> SocketAsyncEventArgs();<br>e.Completed += (socket, args) =&gt; &#123;<br>  <span class="hljs-keyword">if</span>(args.SocketError = SocketError.Success)&#123;<br>    Socket clientSocket = args.Success;<br>    (socket <span class="hljs-keyword">as</span> Socket).AcceptAsync(args);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    print(args.SocketError);<br>  &#125;<br>&#125;;<br>socketTCP.AcceptAsync(e);<br></code></pre></td></tr></table></figure></li>
<li>客户端<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs C#">Socket socketTCP = <span class="hljs-keyword">new</span> (..,..,.<span class="hljs-number">.0</span>);<br>SocketAsyncEventArgs e = <span class="hljs-keyword">new</span> SocketAsyncEventArgs();<br>e.Completed += (socket, args) =&gt; &#123;<br>  <span class="hljs-keyword">if</span>(args.SocketError = SocketError.Success)&#123;<br>    <span class="hljs-comment">//连接成功</span><br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    print(args.SocketError);<br>  &#125;<br>&#125;;<br>socketTCP.ConnectAsync(e);<br></code></pre></td></tr></table></figure></li>
<li>两端<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//发送消息</span><br>SocketAsyncEventArgs e2 = <span class="hljs-keyword">new</span> ();<br><span class="hljs-built_in">byte</span>[] bytes = Encoding.UTF8.GetBytes(<span class="hljs-string">&quot;aaa&quot;</span>);<br>e2.SetBuffer(bytes,<span class="hljs-number">0</span>,bytes.Length);<br>e.Completed += (socket, args) =&gt; &#123; <span class="hljs-comment">//监听是否发送成功</span><br>  <span class="hljs-keyword">if</span>(args.SocketError = SocketError.Success)&#123;<br>    <span class="hljs-comment">//成功</span><br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    print(args.SocketError);<br>  &#125;<br>&#125;;<br>socketTCP.SendAsync(e2);<br><br><span class="hljs-comment">//接收消息</span><br>SocketAsyncEventArgs e3 = <span class="hljs-keyword">new</span> ();<br>e3.SetBuffer(<span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>],<span class="hljs-number">0</span>,<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>);<br>e3.Completed += (socket, args) =&gt; &#123; <span class="hljs-comment">//监听是否接收成功</span><br>  <span class="hljs-keyword">if</span>(args.SocketError = SocketError.Success)&#123;<br>    <span class="hljs-comment">//成功处理逻辑</span><br>    Encoding.UTF8.GetString(args.Buffer,<span class="hljs-number">0</span>,args.BytesTransferred);<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    args.Buffer 收到的字节</span><br><span class="hljs-comment">    args.BytesTransferred 收到字节的长度</span><br><span class="hljs-comment">    */</span><br>    args.SetBuffer(<span class="hljs-number">0</span>,args.Buffer.Length);<br>    (socket <span class="hljs-keyword">as</span> Socket).ReceiveAsync(args);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    print(args.SocketError);<br>  &#125;<br>&#125;;<br>socketTCP.ReceiveAsync(e3);<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h4 id="UDP同步"><a href="#UDP同步" class="headerlink" title="UDP同步"></a><a href="#%E5%A5%97%E6%8E%A5%E5%AD%97socket%E7%B1%BB"><code>UDP</code>同步</a></h4><ul>
<li><code>UDP</code>不存在黏包问题, 分包问题(因为丢包&#x2F;乱序)更严重, 因此需要控制大小在<strong>最大传输单元</strong>(<code>Max Transmission Unit</code>)内, 一般控制大小: 局域网环境1472字节内, 互联网环境内548字节内<ul>
<li>消息过小时可以手动黏包, 过大时手动分包, 分包使用序号,长度,ID等信息确定同一个包</li>
</ul>
</li>
<li><code>C/S</code>代码<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//1. 声明</span><br>Socket socket = <span class="hljs-keyword">new</span> (AddressFamily.InterWorknet, SocketType.Dgram, ProtocolType.Udp);<br><span class="hljs-comment">//2. 绑定</span><br>IPEndPoint ipPoint = <span class="hljs-keyword">new</span> (IPAdrress.Parse(<span class="hljs-string">&quot;127.0.0.1&quot;</span>),<span class="hljs-number">8080</span>);<br>socket.Bind(ipPoint);<br><span class="hljs-comment">//3. 发送消息</span><br>IPEndPoint remoteIpPoint = <span class="hljs-keyword">new</span> (IPAddress.Parse(<span class="hljs-string">&quot;1.0.0.1&quot;</span>),<span class="hljs-number">8081</span>);<br>socket.SendTo(Encoding.UTF8.GetBytes(<span class="hljs-string">&quot;a&quot;</span>),remoteIpPoint);<br><span class="hljs-comment">//4. 接收消息</span><br><span class="hljs-built_in">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">512</span>];<br>EndPoint remoteClientPoint = <span class="hljs-keyword">new</span> IPEndPoint(IPAddress.Any,<span class="hljs-number">0</span>);<br><span class="hljs-built_in">int</span> length = socket.ReceiveFrom(bytes, <span class="hljs-keyword">ref</span> remoteClientPoint);<br>  <span class="hljs-comment">/*收到的byte[]存入bytes中, 收到的EndPoint存入remoteClientPoint中*/</span><br><span class="hljs-comment">//5. 释放关闭</span><br>socket.Shutdown(SocketShutdown.Both);<br>socket.Close();<br></code></pre></td></tr></table></figure></li>
<li>封装<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//存储连接过的客户端</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Client</span><br>&#123;<br>  <span class="hljs-keyword">private</span> IPEndPoint clientIP;<br>  <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> clientID;<br>  <span class="hljs-keyword">public</span> <span class="hljs-built_in">long</span> lastTime = <span class="hljs-number">-1</span>;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Client</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> ip, <span class="hljs-built_in">int</span> port</span>)</span><br>  &#123;<br>    clientIP = <span class="hljs-keyword">new</span> IPEndPoint(IPAddress.Parse(ip), port);<br>    clientID = ip + <span class="hljs-string">&quot;:&quot;</span> + port;<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RcvBytes</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes</span>)</span><br>  &#123;<br>    <span class="hljs-built_in">byte</span>[] cacheBytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>];<br>    lastTime = DataTime.Now.Ticks / TimeSpan.TicksPerSecond;<br>    bytes.CopyTo(cacheBytes, <span class="hljs-number">0</span>);<br>    ThreadPool.QueueUserWorkItem(RcvHandle,cacheBytes);<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RcvHandle</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> obj</span>)</span><br>  &#123;<br>    <span class="hljs-built_in">byte</span>[] bytes = obj <span class="hljs-keyword">as</span> <span class="hljs-built_in">byte</span>[];<br>    <span class="hljs-built_in">int</span> nowIndex = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">int</span> msgID = BitConverter.ToInt32(bytes, nowIndex);<br>    nowIndex += <span class="hljs-number">4</span>;<br>    <span class="hljs-built_in">int</span> msgLength = BitConverter.ToInt32(bytes, nowIndex);<br>    nowIndex += <span class="hljs-number">4</span>;<br>    <span class="hljs-keyword">switch</span> (msgID)<br>    &#123;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1001</span>:<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//服务端</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ServerSocket</span><br>&#123;<br>  Socket sokcet;<br>  <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> isClose;<br>  <span class="hljs-keyword">private</span> Dictionary&lt;<span class="hljs-built_in">string</span>,Client&gt; clientDic = <span class="hljs-keyword">new</span> ();<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> ip, <span class="hljs-built_in">int</span> port</span>)</span><br>  &#123;<br>    <span class="hljs-keyword">if</span>(!isClose)&#123;<span class="hljs-keyword">return</span>;&#125;<br>    IPEndPoint ipPoint = <span class="hljs-keyword">new</span> (IPAddress.Parse(ip), port);<br>    socket = <span class="hljs-keyword">new</span> Socket(..,..,..);<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>      socket.Bind(ipPoint);<br>      isClose = <span class="hljs-literal">false</span>;<br>      ThreadPool.QueueUserWorkItem(RcvMsg);<br>      ThreadPool.QueueUserWorkItem(CheckTimeOut);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Exception e)<br>    &#123;<br>      Debug.log(e.Message);<br>    &#125;<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RcvMsg</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> obj</span>)</span><br>  &#123;<br>    <span class="hljs-built_in">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">512</span>];<br>    EndPoint ipPoint = <span class="hljs-keyword">new</span> IPEndPoint(IPAddress.Any, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">string</span> dicID = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-built_in">string</span> ip;<br>    <span class="hljs-built_in">int</span> port;<br>    <span class="hljs-keyword">while</span>(!isClose)<br>    &#123;<br>      <span class="hljs-keyword">if</span>(socket.Available &gt; <span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-keyword">lock</span>(socket)&#123;<br>          socket.ReceiveFrom(bytes, <span class="hljs-keyword">ref</span> ipPoint);<br>        &#125;<br>        <span class="hljs-comment">//处理逻辑</span><br>        ip = (ipPoint <span class="hljs-keyword">as</span> IPEndPoint).Address.ToString();<br>        port = (ipPoint <span class="hljs-keyword">as</span> IPEndPoint).Port;<br>        dicID = ip + <span class="hljs-string">&quot;:&quot;</span> + port;<br>        <span class="hljs-keyword">if</span>(!clientDic.ContainsKey(dicID))&#123;<br>          clientDic.Add(dicID,<span class="hljs-keyword">new</span> Client(ip,port));<br>        &#125;<br>        clientDic[dicID].RcvBytes(bytes);<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendTo</span>(<span class="hljs-params">BaseMsg msgIPEndPoint ipPoint</span>)</span><br>  &#123;<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>      <span class="hljs-keyword">lock</span>(socket)<br>      &#123;<br>        socket.SendTo(msg.Writing(),ipPoint);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (SocketException e)<br>    &#123;<br>      Debug.log(e.SocketErrorCode + e.Message);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Exception e)<br>    &#123;<br>      Debug.log(e.Message);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Close</span>()</span><br>  &#123;<br>    <span class="hljs-keyword">if</span>(socket != <span class="hljs-literal">null</span>)&#123;<br>      isClose = <span class="hljs-literal">true</span>;<br>      socket.Shutdowm(SocketShutdown.Both);<br>      socket.Close();<br>      socket = <span class="hljs-literal">null</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Remove</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> clientID</span>)</span><br>  &#123;<br>    <span class="hljs-keyword">if</span>(clientDic.ContainsKey(clientID))&#123;<br>      clientDic.Remove(clientID);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CheckTimeOut</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> obj</span>)</span><br>  &#123;<br>    <span class="hljs-built_in">long</span> nowTime = <span class="hljs-number">0</span>;<br>    List&lt;<span class="hljs-built_in">string</span>&gt; delList = <span class="hljs-keyword">new</span> ();<br>    <span class="hljs-built_in">int</span> fori = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span>(!isClose)<br>    &#123;<br>      Thread.Sleep(<span class="hljs-number">30000</span>);<br>      nowTime = DataTime.Now.Ticks / TimeSpan.TicksPerSecond;<br>      <span class="hljs-keyword">foreach</span>(Client c <span class="hljs-keyword">in</span> clientDic.Values)&#123;<br>        <span class="hljs-keyword">if</span>(nowTime - c.lastTime &gt;= <span class="hljs-number">10</span>)&#123;<br>          delList.Add(c.clientID);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">for</span>(fori = <span class="hljs-number">0</span>; fori&lt; delList.Count;fori++)&#123;<br>        Remove(delList[fori]);<br>      &#125;<br>      fori = <span class="hljs-number">0</span>;<br>      delList.Clear();<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//客户端</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UdpNetMgr</span>:<span class="hljs-title">MonoBehaviour</span><br>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> UdpNetMgr instance;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UdpNetMgr Instance =&gt; instance;<br>  <span class="hljs-keyword">private</span> EndPoint ipPoint;<br>  <span class="hljs-keyword">private</span> Socket socket;<br>  <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> isClose;<br>  <span class="hljs-keyword">private</span> Queue&lt;BaseMsg&gt; sendQueue = <span class="hljs-keyword">new</span> ();<br>  <span class="hljs-keyword">private</span> Queue&lt;BaseMsg&gt; receiveQueue = <span class="hljs-keyword">new</span> ();<br>  <span class="hljs-keyword">private</span> <span class="hljs-built_in">byte</span>[] cacheBytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">512</span>];<br><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span><br>  &#123;<br>    instance = <span class="hljs-keyword">this</span>;<br>    DontDestroyOnLoad(<span class="hljs-keyword">this</span>.gameObject);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Update</span>()</span><br>  &#123;<br>    <span class="hljs-keyword">if</span>(receiveQueue.Count &gt; <span class="hljs-number">0</span>)&#123;<br>      BaseMsg baseMsg = receiveQueue.Dequeue();<br>      <span class="hljs-keyword">switch</span>(baseMsg)<br>      &#123;<br>        <span class="hljs-keyword">case</span> PlayerInfo msg:<br>          print(msg.playerID);<br>          <span class="hljs-keyword">break</span>;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">OnDestroy</span>()</span><br>  &#123;<br>    Close();<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">StartClient</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> ip, <span class="hljs-built_in">int</span> port</span>)</span><br>  &#123;<br>    <span class="hljs-keyword">if</span>(!isClose)&#123; <span class="hljs-keyword">return</span> ;&#125;<br>    ipPoint = <span class="hljs-keyword">new</span> IPEndPoint(IPAddress.Parse(ip),port);<br>    IPEndPoint cliengIpPoint = <span class="hljs-keyword">new</span> IPEndPoint(IPAddress.Parse(<span class="hljs-string">&quot;localhost&quot;</span>),<span class="hljs-number">8080</span>);<br>    <span class="hljs-keyword">try</span><br>    &#123;<br>      socket = <span class="hljs-keyword">new</span> Socket(..,..,..);<br>      socket.Bind(cliengIpPoint);<br>      isClose = <span class="hljs-literal">false</span>;<br>      ThreadPool.QueueUserWorkItem(ReceiveMsg);<br>      ThreadPool.QueueUserWorkItem(SendMsg);<br>    &#125;<br>    <span class="hljs-keyword">catch</span> (Exception e)<br>    &#123;<br>      Debug.log(e.Message);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ReceiveMsg</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> obj</span>)</span><br>  &#123;<br>    EndPoint tempIpPoint = <span class="hljs-keyword">new</span> IPEndPoint(IPAddress.Any, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">int</span> nowIndex, msgID, msgLength;<br>    BaseMsg msg = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">while</span>(!isClose)<br>    &#123;<br>      <span class="hljs-keyword">if</span>(socket != <span class="hljs-literal">null</span> &amp;&amp; socket.Available &gt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>          socket.ReceiveFrom(cacheBytes, <span class="hljs-keyword">ref</span> tempIpPoint);<br>          <span class="hljs-comment">//避免骚扰</span><br>          <span class="hljs-keyword">if</span>(!tempIpPoint.Equals(ipPoint))&#123;<br>            <span class="hljs-keyword">continue</span>;<br>          &#125;<br>          <span class="hljs-comment">//处理消息</span><br>          nowIndex = <span class="hljs-number">0</span>;<br>          msgID = BitConverter.ToInt32(cacheBytes, nowIndex);<br>          nowIndex +=<span class="hljs-number">4</span>;<br>          msgLength = BitConverter.ToInt32(cacheBytes, nowIndex);<br>          nowIndex +=<span class="hljs-number">4</span>;<br>          <span class="hljs-keyword">switch</span>(msgID)<br>          &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1001</span>:<br>              msg = <span class="hljs-keyword">new</span> PlayerInfo();<br>              msg.Reading(cacheBytes, nowIndex);<br>              <span class="hljs-keyword">break</span>;<br>          &#125;<br>          <span class="hljs-keyword">if</span>(msg!=nul)&#123;<br>            receiveQueue.Enqueue(msg);<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (SocketException e)<br>        &#123;<br>          Debug.Lod(e.SocketErrorCode + e.Message);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception e)<br>        &#123;<br>          Debug.Log(e.Message);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendMsg</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> obj</span>)</span><br>  &#123;<br>    <span class="hljs-keyword">while</span>(!isClose)&#123;<br>      <span class="hljs-keyword">if</span>(socket != <span class="hljs-literal">null</span> &amp;&amp; sendQueue.Count &gt; <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">try</span><br>        &#123;<br>          socket.SendTo(sendQueue.Dequeue().Writing(),ipPoint);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception e)<br>        &#123;<br>          Debug.Log(e.SocketErrorCode + e.Message);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Send</span>(<span class="hljs-params">BaseMsg msg</span>)</span><br>  &#123;<br>    sendQueue.Enqueue(msg);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Close</span>()</span><br>  &#123;<br>    <span class="hljs-keyword">if</span>(socket != <span class="hljs-literal">null</span>)&#123;<br>      isClose = <span class="hljs-literal">true</span>;<br>      <span class="hljs-comment">/*发一个退出消息*/</span><br>      socket.Shutdown(SocketShutdown.Both);<br>      socket.Close();<br>      socket = <span class="hljs-literal">null</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="UDP异步"><a href="#UDP异步" class="headerlink" title="UDP异步"></a><a href="#%E5%A5%97%E6%8E%A5%E5%AD%97socket%E7%B1%BB"><code>UDP</code>异步</a></h4><ul>
<li><code>Begin</code>方法<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C#">IAsyncResult socket.BeginSendTo(<span class="hljs-built_in">byte</span>[] buffer, <span class="hljs-comment">//bytes</span><br>                                <span class="hljs-built_in">int</span> offset, <span class="hljs-comment">//偏移量</span><br>                                <span class="hljs-built_in">int</span> size, <span class="hljs-comment">//字节长度</span><br>                                SocketFlags flag, <span class="hljs-comment">//使用None就可以</span><br>                                EndPoint remoteEP, <span class="hljs-comment">//远程IP</span><br>                                AsyncCallback callback,<br>                                <span class="hljs-built_in">object</span> state <span class="hljs-comment">/*额外的参数*/</span>)<br><span class="hljs-comment">//在回调委托中使用EndSendTo()</span><br><span class="hljs-comment">//BeginReceiveFrom()同</span><br></code></pre></td></tr></table></figure>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs C#">socket.BeginSendTo(bytes,<br>                    <span class="hljs-number">0</span>,<br>                    bytes.Length,<br>                    SocketFlags.None,<br>                    ipPoint,<br>                    SendToCallback,<br>                    socket);<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendToCallback</span>(<span class="hljs-params">IAsyncResult res</span>)</span><br>&#123;<br>  <span class="hljs-keyword">try</span><br>  &#123;<br>    Socket s = res.AsyncState <span class="hljs-keyword">as</span> Socket;<br>    s.EndSendTo(res);<br>  &#125;<br>  <span class="hljs-keyword">catch</span> (SocketException e)<br>  &#123;<br>    Debug.Log(e.SocketErrorCode + e.Message);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><code>Async</code>方法<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs C#">SocketEventAsyncArgs args = <span class="hljs-keyword">new</span> ();<br>args.SetBuffer(bytes,<span class="hljs-number">0</span>, bytes.Length);<br>args.Completed += SendToAsyncCallback;<br>socket.SendToAsync(args);<br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendToAsyncCallback</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> s,SocketEventAsyncArgs args</span>)</span><br>&#123;<br>  <span class="hljs-comment">//回调事件</span><br>  <span class="hljs-keyword">if</span>(args.SocketErrorCode == SocketError.Success)&#123;<br>    <span class="hljs-comment">//成功</span><br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-comment">//失败</span><br>  &#125;<br>&#125;<br><span class="hljs-comment">//ReceiveFromAsync同理</span><br><span class="hljs-comment">//接收后继续接收</span><br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="文件传输FTP"><a href="#文件传输FTP" class="headerlink" title="文件传输FTP"></a><a href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1">文件传输<code>FTP</code></a></h3><ul>
<li><code>File Transfer Protocol</code>: 上传下载文件的一套规则<blockquote>
<p>本质是两个<code>TCP</code>连接, 一个控制传输, 一个传输数据<br><br>两种传输模式: 1. 主动(<code>Port</code>)模式, 传输数据请求由服务器发起, 受到客户端防火墙影响用的较少; 2. 被动(<code>Passive</code>)模式, 传输数据请求由客户端发起<br><br>两种传输方式: 1. <code>ASCII</code>, 适用于<strong>仅包含英文</strong>的<strong>命令</strong>, <strong>参数</strong>和<strong>英文文本文件</strong>; 2. <code>二进制</code>方式(<em><strong>推荐</strong></em>), 可以指定编码方式, 传输非英文文本</p>
</blockquote>
</li>
<li>相关类: <code>FtpWebRequest</code>, <code>FtpWebResponse</code>, <code>NetworkCredential</code></li>
<li>解决的问题: 1. 搭建<code>FTP</code>服务器; 2. 上传; 3. 下载</li>
</ul>
<h4 id="搭建FTP服务器"><a href="#搭建FTP服务器" class="headerlink" title="搭建FTP服务器"></a><a href="#%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93ftp">搭建<code>FTP</code>服务器</a></h4><ul>
<li>三种方式<blockquote>
<ol>
<li>使用别人写好的<code>FTP</code>软件搭建(推荐)(<code>Serv-U</code>)<br></li>
<li>根据原理写<code>FTP</code>(一般后端, 后端一般也不写)<br></li>
</ol>
</blockquote>
</li>
<li><code>NetworkCredential</code>: 设置账号密码<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs C#">NetworkCredential n = <span class="hljs-keyword">new</span> (<span class="hljs-built_in">string</span> username, <span class="hljs-built_in">string</span> password);<br></code></pre></td></tr></table></figure></li>
<li><code>FtpWebRequest</code>: 客户端操作类, 发送上传下载删除文件的命令<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//方法</span><br><span class="hljs-comment">//1. 绑定服务器对象Create()</span><br>FtpWebRequest r = FtpWebRequest.Create(<span class="hljs-string">&quot;ftp://127.0.0.1/a.txt&quot;</span>) <span class="hljs-keyword">as</span> FtpWebRequest;<br><span class="hljs-comment">//2. 正在进行文件传输时中止传输Abort()</span><br>r.Abort();<br><span class="hljs-comment">//3. 获取上传流GetRequestStream()</span><br>Stream s = r.GetRequestStream();<br><span class="hljs-comment">//4. 服务器响应WebResponse GetResponse()</span><br>FtpWebResponse res = r.GetResponse() <span class="hljs-keyword">as</span> FtpWebResponse;<br></code></pre></td></tr></table></figure>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//成员变量</span><br><span class="hljs-comment">//1. Credentials通信凭证</span><br>r.Credentials = n;<br><span class="hljs-comment">//2. KeepAlive完成传输后是否继续保持连接状态, 默认true</span><br>r.KeepAlive = <span class="hljs-literal">false</span>;<br><span class="hljs-comment">//3. 操作命令, 使用WebResquestMethods.Ftp静态类的静态常量实现的枚举string</span><br><span class="hljs-comment">//  删除文件,下载文件,文件列表,详细列表,创建目录,删除目录,上传文件</span><br>r.Method = WebResquestMethods.Ftp.DownloadFile;<br><span class="hljs-comment">//4. 是否使用二进制传输UseBinary</span><br>r.UseBinary = <span class="hljs-literal">true</span>;<br><span class="hljs-comment">//5. 重命名RenameTo(string s)</span><br>r.RenameTo(<span class="hljs-string">&quot;b.txt&quot;</span>);<br></code></pre></td></tr></table></figure></li>
<li><code>FtpWebResponse</code>类: 服务器对请求的响应, 使用成员方法<code>GetResponse()</code>获取, 使用完毕后要<code>Close()</code><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs C#">FtpWebResponse res = r.GetResponse() <span class="hljs-keyword">as</span> FtpWebResponse;<br><span class="hljs-comment">/*r属性设置完毕后, 调用GetResponse()方法才会发送r并获得响应*/</span><br><span class="hljs-comment">//1. 关闭Close()</span><br>res.Close();<br><span class="hljs-comment">//2. 获取下载数据流</span><br>Stream s = res.GetResponseStream();<br></code></pre></td></tr></table></figure>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//1. 接收数据长度ContentLength</span><br><span class="hljs-built_in">int</span> l = res.ContentLength;<br><span class="hljs-comment">//2. 接收数据类型ContentType</span><br><span class="hljs-built_in">string</span> typeString = res.ContentType;<br><span class="hljs-comment">//3. 服务器发送的最新状态码StatusCode枚举</span><br>print(res.StatusCode);<br><span class="hljs-comment">//4. 服务器发送的最新状态文本StatusDescription</span><br>print(res.StatusDescription);<br><span class="hljs-comment">//5. 建立连接时/会话结束时服务器发送的消息BannerMessage/ExitMessage</span><br>print(res.BannerMessage);<br><span class="hljs-comment">//6. 文件上次修改日期</span><br>print(res.LastModified);<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="上传"><a href="#上传" class="headerlink" title="上传"></a><a href="#%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93ftp">上传</a></h4><ul>
<li>上传流程<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">try</span>&#123;<br>  FtpWebRequest r = FtpWebRequest.Create(<span class="hljs-string">&quot;ftp://127.0.0.1/a.txt&quot;</span>) <span class="hljs-keyword">as</span> FtpWebRequest;<br>  NetworkCredential n = <span class="hljs-keyword">new</span> (<span class="hljs-string">&quot;admin&quot;</span>, <span class="hljs-string">&quot;admin&quot;</span>);<br>  r.Credentials = n;<br>  r.Proxy = <span class="hljs-literal">null</span>; <span class="hljs-comment">//避免使用ftp的同时启动http服务</span><br>  r.Method = WebResquestMethods.Ftp.UploadFile;<br>  r.KeepAlive = <span class="hljs-literal">false</span>;<br>  r.UseBinary = <span class="hljs-literal">true</span>;<br>  Stream s = r.GetRequestStream();<br>  <span class="hljs-keyword">using</span>(FileStream file = File.OpenRead(<span class="hljs-string">&quot;文件目录.txt&quot;</span>))<br>  &#123;<br>    <span class="hljs-built_in">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>];<br>    <span class="hljs-built_in">int</span> l = file.Read(bytes,<span class="hljs-number">0</span>,bytes.Length);<br>    <span class="hljs-keyword">while</span>(l != <span class="hljs-number">0</span>)&#123;<br>      s.Write(bytes,<span class="hljs-number">0</span>,l);<br>      l = file.Read(bytes,<span class="hljs-number">0</span>,bytes.Length);<br>    &#125;<br>    file.Close();<br>    s.Close();<br>    <span class="hljs-comment">/*上传完毕*/</span><br>  &#125;<br>&#125;<br><span class="hljs-keyword">catch</span> (Exception e)<br>&#123;<br>  Debug.Log(e.Message);<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>上传单例类<code>FtpMgr</code><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FtpMgr</span><br>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> FtpMgr instance = <span class="hljs-keyword">new</span> FtpMgr();<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> FtpMgr Instance =&gt; instance;<br>  <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> FTP_PATH = <span class="hljs-string">&quot;ftp://127.0.0.1/&quot;</span>;<br>  <span class="hljs-keyword">private</span> NetworkCredential n = <span class="hljs-keyword">new</span> (<span class="hljs-string">&quot;admin&quot;</span>,<span class="hljs-string">&quot;adminpwd&quot;</span>);<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UploadFile</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> fileName, <span class="hljs-built_in">string</span> localPath, UnityAction action = <span class="hljs-literal">null</span></span>)</span><br>  &#123;<br>    <span class="hljs-keyword">await</span> Task.Run(() =&gt; &#123;<br>      <span class="hljs-keyword">try</span>&#123;<br>        FtpWebRequest r = FtpWebRequest.Create(FTP_PATH + fileName) <span class="hljs-keyword">as</span> FtpWebRequest;<br>        r.Credentials = n;<br>        r.Proxy = <span class="hljs-literal">null</span>; <span class="hljs-comment">//避免使用ftp的同时启动http服务</span><br>        r.Method = WebResquestMethods.Ftp.UploadFile;<br>        r.KeepAlive = <span class="hljs-literal">false</span>;<br>        r.UseBinary = <span class="hljs-literal">true</span>;<br>        Stream s = r.GetRequestStream();<br>        <span class="hljs-keyword">using</span>(FileStream file = File.OpenRead(localPath))<br>        &#123;<br>          <span class="hljs-built_in">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>];<br>          <span class="hljs-built_in">int</span> l = file.Read(bytes,<span class="hljs-number">0</span>,bytes.Length);<br>          <span class="hljs-keyword">while</span>(l != <span class="hljs-number">0</span>)&#123;<br>            s.Write(bytes,<span class="hljs-number">0</span>,l);<br>            l = file.Read(bytes,<span class="hljs-number">0</span>,bytes.Length);<br>          &#125;<br>          file.Close();<br>          s.Close();<br>          <span class="hljs-comment">/*上传完毕*/</span><br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (Exception e)<br>      &#123;<br>        Debug.Log(e.Message);<br>      &#125;<br>    &#125;);<br>    action?.Invoke();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a><a href="#%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93ftp">下载</a></h4><ul>
<li>下载流程<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">try</span><br>&#123;<br>  FtpWebRequest r = FtpWebRequest.Create(<span class="hljs-string">&quot;ftp://127.0.0.1/a.txt&quot;</span>) <span class="hljs-keyword">as</span> FtpWebRequest;<br>  <span class="hljs-comment">//这个文件必须是服务器上有的</span><br>  r.Credentials = <span class="hljs-keyword">new</span> NetworkCredential(<span class="hljs-string">&quot;admin&quot;</span>, <span class="hljs-string">&quot;admin&quot;</span>);<br>  r.Method = WebResquestMethods.Ftp.DownloadFile;<br>  r.Proxy = <span class="hljs-literal">null</span>;<br>  r.KeepAlive = <span class="hljs-literal">false</span>;<br>  r.UseBinary = <span class="hljs-literal">true</span>;<br>  FtpWebResponse res = r.GetResponse() <span class="hljs-keyword">as</span> FtpWebResponse; <span class="hljs-comment">/*下载请求*/</span><br>  Stream dlStream = res.GetResponseStream(); <span class="hljs-comment">/*下载流*/</span><br>  <span class="hljs-keyword">using</span>(FileStream file = File.Create(<span class="hljs-string">&quot;下载地址加文件名.txt&quot;</span>))&#123;<br>    <span class="hljs-built_in">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>];<br>    <span class="hljs-built_in">int</span> l = dlStream.Read(bytes,<span class="hljs-number">0</span>,bytes.Length);<br>    <span class="hljs-keyword">while</span>(l != <span class="hljs-number">0</span>)&#123;<br>      file.Write(bytes,<span class="hljs-number">0</span>,l);<br>      l = dlStream.Read(bytes,<span class="hljs-number">0</span>,bytes.Length);<br>    &#125;<br>    dlStream.Close();<br>    file.Close();<br>  &#125;<br>&#125;<br><span class="hljs-keyword">catch</span> (Exception e)<br>&#123;<br>  Debug.Log(e.Message);<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>下载单例类<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FtpMgr</span><br>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DownloadFile</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> fileName, <span class="hljs-built_in">string</span> localPath, UnityAction action = <span class="hljs-literal">null</span></span>)</span><br>  &#123;<br>    <span class="hljs-keyword">await</span> Task.Run(() =&gt; &#123;<br>      <span class="hljs-keyword">try</span><br>      &#123;<br>        FtpWebRequest r = FtpWebRequest.Create(FTP_PATH + fileName) <span class="hljs-keyword">as</span> FtpWebRequest;<br>        r.Credentials = n;<br>        r.Method = WebResquestMethods.Ftp.DownloadFile;<br>        r.Proxy = <span class="hljs-literal">null</span>;<br>        r.KeepAlive = <span class="hljs-literal">false</span>;<br>        r.UseBinary = <span class="hljs-literal">true</span>;<br>        FtpWebResponse res = r.GetResponse() <span class="hljs-keyword">as</span> FtpWebResponse;<br>        Stream dlStream = res.GetResponseStream();<br>        <span class="hljs-keyword">using</span>(FileStream file = File.Create(localPath))&#123;<br>          <span class="hljs-built_in">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>];<br>          <span class="hljs-built_in">int</span> l = dlStream.Read(bytes,<span class="hljs-number">0</span>,bytes.Length);<br>          <span class="hljs-keyword">while</span>(l != <span class="hljs-number">0</span>)&#123;<br>            file.Write(bytes,<span class="hljs-number">0</span>,l);<br>            l = dlStream.Read(bytes,<span class="hljs-number">0</span>,bytes.Length);<br>          &#125;<br>          dlStream.Close();<br>          file.Close();<br>        &#125;<br>        res.Close();<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (Exception e)<br>      &#123;<br>        Debug.Log(e.Message);<br>      &#125;<br>    &#125;);<br>    action?.Invoke();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="FTP其他操作"><a href="#FTP其他操作" class="headerlink" title="FTP其他操作"></a><a href="#%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93ftp"><code>FTP</code>其他操作</a></h4><ul>
<li>删除文件<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FtpMgr</span><br>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DeleteFile</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> fileName, UnityAction&lt;<span class="hljs-built_in">bool</span>&gt; action = <span class="hljs-literal">null</span></span>)</span><br>  &#123;<br>    <span class="hljs-keyword">await</span> Task.Run(() =&gt; &#123;<br>      <span class="hljs-keyword">try</span><br>      &#123;<br>        FtpWebRequest r = FtpWebRequest.Create(FTP_PATH + fileName) <span class="hljs-keyword">as</span> FtpWebRequest;<br>        r.Credentials = n;<br>        r.Method = WebResquestMethods.Ftp.DeleteFile;<br>        r.Proxy = <span class="hljs-literal">null</span>;<br>        r.KeepAlive = <span class="hljs-literal">false</span>;<br>        r.UseBinary = <span class="hljs-literal">true</span>;<br>        FtpWebResponse res = r.GetResponse() <span class="hljs-keyword">as</span> FtpWebResponse;<br>        Stream dlStream = res.GetResponseStream();<br>        res.Close();<br>        action?.Invoke(<span class="hljs-literal">true</span>);<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (Exception e)<br>      &#123;<br>        Debug.Log(e.Message);<br>        action?.Invoke(<span class="hljs-literal">false</span>);<br>      &#125;<br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>获取文件大小<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FtpMgr</span><br>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GetFileSize</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> fileName, UnityAction&lt;<span class="hljs-built_in">long</span>&gt; action = <span class="hljs-literal">null</span></span>)</span><br>  &#123;<br>    <span class="hljs-keyword">await</span> Task.Run(() =&gt; &#123;<br>      <span class="hljs-keyword">try</span><br>      &#123;<br>        FtpWebRequest r = FtpWebRequest.Create(FTP_PATH + fileName) <span class="hljs-keyword">as</span> FtpWebRequest;<br>        r.Credentials = n;<br>        r.Method = WebResquestMethods.Ftp.GetFileSize;<br>        r.Proxy = <span class="hljs-literal">null</span>;<br>        r.KeepAlive = <span class="hljs-literal">false</span>;<br>        r.UseBinary = <span class="hljs-literal">true</span>;<br>        FtpWebResponse res = r.GetResponse() <span class="hljs-keyword">as</span> FtpWebResponse;<br>        Stream dlStream = res.GetResponseStream();<br>        res.Close();<br>        action?.Invoke(res.ContentLength);<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (Exception e)<br>      &#123;<br>        Debug.Log(e.Message);<br>        action?.Invoke(<span class="hljs-number">0</span>);<br>      &#125;<br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>创建文件夹<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FtpMgr</span><br>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CreateDirectory</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> dirName, UnityAction&lt;<span class="hljs-built_in">bool</span>&gt; action = <span class="hljs-literal">null</span></span>)</span><br>  &#123;<br>    <span class="hljs-keyword">await</span> Task.Run(() =&gt; &#123;<br>      <span class="hljs-keyword">try</span><br>      &#123;<br>        FtpWebRequest r = FtpWebRequest.Create(FTP_PATH + dirName) <span class="hljs-keyword">as</span> FtpWebRequest;<br>        r.Credentials = n;<br>        r.Method = WebResquestMethods.Ftp.MakeDirectory;<br>        r.Proxy = <span class="hljs-literal">null</span>;<br>        r.KeepAlive = <span class="hljs-literal">false</span>;<br>        r.UseBinary = <span class="hljs-literal">true</span>;<br>        FtpWebResponse res = r.GetResponse() <span class="hljs-keyword">as</span> FtpWebResponse;<br>        res.Close();<br>        action?.Invoke(<span class="hljs-literal">true</span>);<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (Exception e)<br>      &#123;<br>        Debug.Log(e.Message);<br>        action?.Invoke(<span class="hljs-literal">false</span>);<br>      &#125;<br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>获取文件列表<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FtpMgr</span><br>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GetFileList</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> dirName, UnityAction&lt;List&lt;<span class="hljs-built_in">string</span>&gt;&gt; action = <span class="hljs-literal">null</span></span>)</span><br>  &#123;<br>    <span class="hljs-keyword">await</span> Task.Run(() =&gt; &#123;<br>      <span class="hljs-keyword">try</span><br>      &#123;<br>        FtpWebRequest r = FtpWebRequest.Create(FTP_PATH + dirName) <span class="hljs-keyword">as</span> FtpWebRequest;<br>        r.Credentials = n;<br>        r.Method = WebResquestMethods.Ftp.ListDirectory;<br>        r.Proxy = <span class="hljs-literal">null</span>;<br>        r.KeepAlive = <span class="hljs-literal">false</span>;<br>        r.UseBinary = <span class="hljs-literal">true</span>;<br>        FtpWebResponse res = r.GetResponse() <span class="hljs-keyword">as</span> FtpWebResponse;<br>        StreamReader sr = <span class="hljs-keyword">new</span> (res.GetResponseStream());<br>        List&lt;<span class="hljs-built_in">string</span>&gt; l = <span class="hljs-keyword">new</span> ();<br>        <span class="hljs-built_in">string</span> line = sr.ReadLine();<br>        <span class="hljs-keyword">while</span>(line != <span class="hljs-literal">null</span>)&#123;<br>          l.Add(line);<br>          line = sr.ReadLine();<br>        &#125;<br>        res.Close();<br>        action?.Invoke(l);<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (Exception e)<br>      &#123;<br>        Debug.Log(e.Message);<br>        action?.Invoke(<span class="hljs-literal">null</span>);<br>      &#125;<br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="超文本传输HTTP"><a href="#超文本传输HTTP" class="headerlink" title="超文本传输HTTP"></a><a href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1">超文本传输<code>HTTP</code></a></h3><h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a><a href="#%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93http">原理</a></h4><ul>
<li><code>HTTP</code>: HyperText Transfer Protocol, 主要传输超文本的网络协议. 本质是<code>TCP</code>通信</li>
<li><code>http</code>协议规定了在数据前添加<strong>元信息</strong>(<code>metainformation</code>)<strong>标头</strong>(<code>header</code>)解释数据, 包含数据类型&#x2F;编码方式等</li>
<li>请求类型(<code>HTTP/1.1</code>): <code>GET</code>,<code>POST</code>,<code>HEAD</code>,<code>PUT</code>,<code>DELETE</code>,<code>OPTIONS</code>,<code>TRACE</code>,<code>CONNECT</code><table>
<thead>
<tr>
<th>请求类型</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><code>GET</code></td>
<td>请求获取特定资源, 如一个web页面或资源</td>
</tr>
<tr>
<td><code>POST</code></td>
<td>提交数据, 如上传文件</td>
</tr>
<tr>
<td><code>HEAD</code></td>
<td>请求获取特定资源, 但不返回具体内容, 可以判断有没有特定文件</td>
</tr>
</tbody></table>
</li>
<li>响应状态码: 1**, 2**, 3**, 4**, 5**<table>
<thead>
<tr>
<th>编号</th>
<th>状态码</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>200</td>
<td><code>OK</code></td>
<td>找到资源, 一切正常</td>
</tr>
<tr>
<td>304</td>
<td><code>NOT MODIFIED</code></td>
<td>资源在上次请求后没有更改(缓存机制中用)</td>
</tr>
<tr>
<td>401</td>
<td><code>UNAUTHORIZED</code></td>
<td>客户端无权访问, 通常需要账号和密码</td>
</tr>
<tr>
<td>403</td>
<td><code>FORBIDDON</code></td>
<td>客户端未授权, 如错误的密码</td>
</tr>
<tr>
<td>404</td>
<td><code>NOT FOUND</code></td>
<td>资源不存在</td>
</tr>
<tr>
<td>405</td>
<td><code>METHOD NOT ALLOWED</code></td>
<td>请求方法不支持</td>
</tr>
<tr>
<td>501</td>
<td><code>NOT IMPLEMENTED</code></td>
<td>服务器不能识别请求或未能实现请求</td>
</tr>
</tbody></table>
</li>
<li><code>C#</code>相关类: <code>WebRequest</code>,<code>HttpWebRequest</code>,<code>HttpWebResponse</code></li>
<li><code>Unity</code>相关类: <code>UnityWebRequest</code>,<code>WWW</code>,<code>WWWFrom</code></li>
</ul>
<h4 id="搭建http服务器"><a href="#搭建http服务器" class="headerlink" title="搭建http服务器"></a><a href="#%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93http">搭建<code>http</code>服务器</a></h4><ul>
<li>使用别人做好的软件搭建(推荐)(<code>hfs</code>)</li>
<li>默认<code>80</code>端口号, 不是则显示<code>:端口号</code></li>
</ul>
<h4 id="C-相关类"><a href="#C-相关类" class="headerlink" title="C#相关类"></a><a href="#%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93http"><code>C#</code>相关类</a></h4><ul>
<li><p><code>HttpWebRequest</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//重要方法</span><br><span class="hljs-comment">//1. Create</span><br>HttpWebRequest r = HttpWebRequest.Create(<span class="hljs-string">&quot;http://baidu.com&quot;</span>) <span class="hljs-keyword">as</span> HttpWebRequest;<br><span class="hljs-comment">//2. Abort 中止</span><br>r.Abort();<br><span class="hljs-comment">//3. GetRequestStream 获取请求流, 支持Begin/End异步</span><br>Stream s = r.GetRequestStream();<br><span class="hljs-comment">//4. GetResponse 返回服务器响应, 支持Begin/End异步</span><br>HttpWebResponse res = r.GetResponse() <span class="hljs-keyword">as</span> HttpWebResponse;<br><br><span class="hljs-comment">//重要成员变量</span><br><span class="hljs-comment">//1. Credentials 账号密码凭证</span><br><span class="hljs-comment">//2. PreAuthenticate 是否需要身份验证</span><br><span class="hljs-comment">//3. Headers 标头键值对</span><br><span class="hljs-comment">//4. ContentLength 发送字节长度, Request时需要设置</span><br><span class="hljs-comment">//5. ContentType POST时需要对内容设置Type</span><br><span class="hljs-comment">//6. Method 操作命令: WehRequestMethods.Http.</span><br><span class="hljs-comment">//    Get</span><br><span class="hljs-comment">//    Post</span><br><span class="hljs-comment">//    Head</span><br></code></pre></td></tr></table></figure></li>
<li><p><code>HttpWebResponse</code></p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//成员方法</span><br><span class="hljs-comment">//1. Close()</span><br><span class="hljs-comment">//2. GetResponseStream() 获取下载流</span><br><br><span class="hljs-comment">//成员变量</span><br><span class="hljs-comment">//1. ContentLength 接收到的数据的长度</span><br><span class="hljs-comment">//2. ContentType 接收到的数据类型</span><br><span class="hljs-comment">//3. StatusCode 服务器下发的最新状态码</span><br><span class="hljs-comment">//4. StatusDescription 服务器下发的状态文本</span><br><span class="hljs-comment">//5. BannerMessage</span><br><span class="hljs-comment">//6. ExitMessage</span><br><span class="hljs-comment">//7. LastModified</span><br></code></pre></td></tr></table></figure></li>
<li><p>下载数据流程</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//检测资源可用性</span><br><span class="hljs-keyword">try</span><br>&#123;<br>  HttpWebRequest r = HttpWebRequest.Create(<span class="hljs-string">&quot;http://baidu.com/logo.png&quot;</span>) <span class="hljs-keyword">as</span> HttpWebRequest;<br>  r.Method = WebRequestMethods.Http.Head;<br>  r.Timeout = <span class="hljs-number">2000</span>;<br>  HttpWebResponse res = r.GetResponse() <span class="hljs-keyword">as</span> HttpWebResponse;<br>  <span class="hljs-keyword">if</span>(res.StatusCode == HttpStatusCode.OK)&#123;<br>    <span class="hljs-comment">//资源可用</span><br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>    print(r.StatusCode + r.StatusDescription);<br>  &#125;<br>&#125;<br><span class="hljs-keyword">catch</span> (WebException e)<br>&#123;<br>  Debug.Log(e.Status + e.Message);<br>&#125;<br><br><span class="hljs-comment">//下载资源</span><br><span class="hljs-keyword">try</span><br>&#123;<br>  HttpWebRequest r = HttpWebRequest.Create(<span class="hljs-string">&quot;http://baidu.com/logo.png&quot;</span>) <span class="hljs-keyword">as</span> HttpWebRequest;<br>  r.Method = WebRequestMethods.Http.Get;<br>  r.Timeout = <span class="hljs-number">2000</span>;<br>  HttpWebResponse res = r.GetResponse() <span class="hljs-keyword">as</span> HttpWebResponse;<br>  <span class="hljs-keyword">if</span>(res.StatusCode == HttpStatusCode.OK)&#123;<br>    <span class="hljs-keyword">using</span>(FileStream fs = File.Create(<span class="hljs-string">&quot;Path路径.png&quot;</span>))&#123;<br>      Stream s = res.GetResponseStream();<br>      <span class="hljs-built_in">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">2048</span>];<br>      <span class="hljs-built_in">int</span> l = s.Read(bytes,<span class="hljs-number">0</span>,bytes.Length);<br>      <span class="hljs-keyword">while</span>(l!=<span class="hljs-number">0</span>)&#123;<br>        s.Write(bytes,<span class="hljs-number">0</span>,bytes.Length);<br>        l = s.Read(bytes,<span class="hljs-number">0</span>,bytes.Length);<br>      &#125;<br>      fs.Close();<br>      s.Close();<br>    &#125;<br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>    print(r.StatusCode + r.StatusDescription);<br>  &#125;<br>&#125;<br><span class="hljs-keyword">catch</span> (WebException e)<br>&#123;<br>  Debug.Log(e.Status + e.Message);<br>&#125;<br><br><span class="hljs-comment">//Get携带额外信息: 链接加?</span><br></code></pre></td></tr></table></figure></li>
<li><p>下载数据单例管理</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HttpMgr</span><br>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> HttpMgr instance = <span class="hljs-keyword">new</span> HttpMgr();<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HttpMgr Instance =&gt; instance;<br>  <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> HTTP_PATH = <span class="hljs-string">&quot;http://127.0.0.1:8080/httpserver/&quot;</span>;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">DownloadFile</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> fileName, <span class="hljs-built_in">string</span> localPath, UnityAction&lt;HttpStatusCode&gt; action</span>)</span><br>  &#123;<br>    HttpStatusCode result = HttpStatusCode.OK;<br>    <span class="hljs-keyword">await</span> Task.Run(() =&gt; &#123;<br>      <span class="hljs-keyword">try</span><br>      &#123;<br>        HttpWebRequest r = HttpWebRequest.Create(HTTP_PATH + fileName) <span class="hljs-keyword">as</span> HttpWebRequest;<br>        r.Method = WebRequestMethods.Http.Head;<br>        r.Timeout = <span class="hljs-number">2000</span>;<br>        HttpWebResponse res = r.GetResponse() <span class="hljs-keyword">as</span> HttpWebResponse;<br>        <span class="hljs-keyword">if</span>(res.StatusCode == HttpStatusCode.OK)&#123;<br>          res.Close();<br>          <span class="hljs-comment">//资源可用</span><br>          r.Method = WebRequestMethods.Http.Get;<br>          res = r.GetResponse() <span class="hljs-keyword">as</span> HttpWebResponse;<br>          <span class="hljs-keyword">if</span>(res.StatusCode == HttpStatusCode.OK)&#123;<br>            <span class="hljs-keyword">using</span>(FileStream fs = File.Create(localPath))&#123;<br>              Stream s = res.GetResponseStream();<br>              <span class="hljs-built_in">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">2048</span>];<br>              <span class="hljs-built_in">int</span> l = s.Read(bytes,<span class="hljs-number">0</span>,bytes.Length);<br>              <span class="hljs-keyword">while</span>(l!=<span class="hljs-number">0</span>)&#123;<br>                s.Write(bytes,<span class="hljs-number">0</span>,bytes.Length);<br>                l = s.Read(bytes,<span class="hljs-number">0</span>,bytes.Length);<br>              &#125;<br>              fs.Close();<br>              s.Close();<br>            &#125;<br>            result = HttpStatusCode.OK;<br>          &#125;<span class="hljs-keyword">else</span>&#123;<br>            result = res.StatusCode;<br>          &#125;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>          result = res.StatusCode;<br>        &#125;<br>        res.Close();<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (WebException e)<br>      &#123;<br>        result = HttpStatusCode.InternalServerError;<br>        Debug.Log(e.Status + e.Message);<br>      &#125;<br>    &#125;);<br>    action?.Invoke(result);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p><code>Post</code>VS<code>Get</code></p>
<ul>
<li>相同: 都可以携带参数发送数据, 并接收数据</li>
<li>不同: 1. <code>Post</code>参数不可见, 更安全; 2. <code>Get</code>需要拼接链接参数, 但<code>url</code>有长度限制; 3. <code>Get</code>内容可被浏览器缓存, <code>Post</code>不会被缓存; 4. <code>Get</code>所有请求一次性发送, <code>Post</code>可能分多次发送</li>
<li><code>Post</code>携带参数: 设置<code>HttpWebRequest</code>对象的<code>ContentType</code>为<code>&quot;application/x-www-form-urlencoded&quot;</code></li>
<li><code>ContentType</code>类型<blockquote>
<p>文本型: <em><strong><code>text/plain</code></strong></em>, <code>text/html</code>, <code>text/css</code>, <code>text/javascript</code><br><br>图片型: <code>image/</code> + <code>gif</code>&#x2F;<code>png</code>&#x2F;<code>jpeg</code>&#x2F;<code>bm</code>&#x2F;<code>webp</code><br><br>音频型: <code>audio/</code> + <code>midi</code>&#x2F;<code>mpeg</code>&#x2F;<code>webm</code>&#x2F;<code>ogg</code>&#x2F;<code>wav</code><br><br>视频型: <code>video/</code> + <code>webm</code>&#x2F;<code>ogg</code><br><br>二进制类型: <code>application/</code> + <em><strong><code>octet-stream</code>(没有其他类型)</strong></em>&#x2F;<em><strong><code>x-www-form-urlencoded</code>(键值对)</strong></em>&#x2F;<code>xml</code>&#x2F;<code>pdf</code><br><br>复合类型: <code>multipart/</code> + <em><strong><code>form-data</code></strong></em>&#x2F;<code>byteranges</code></p>
</blockquote>
</li>
</ul>
</li>
<li><p>上传数据流程</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//1. 实例化并设置参数</span><br>HttpWebRequest rq = HttpWebRequest.Create(<span class="hljs-string">&quot;无文件名目录&quot;</span>) <span class="hljs-keyword">as</span> HttpWebRequest;<br>rq.Method = WebRequestMethods.Http.Post;<br>rq.Timeout = <span class="hljs-number">30000</span>; <span class="hljs-comment">//根据文件大小设置</span><br><span class="hljs-built_in">string</span> boundry = DataTime.Now;<br>rq.ContentType = <span class="hljs-string">&quot;application/form-data;boundry=&quot;</span> + boundry;<br>rq.PreAuthenticate = <span class="hljs-literal">true</span>; <span class="hljs-comment">/*是否先验证身份再上传*/</span><br>rq.Credentials = <span class="hljs-keyword">new</span> NetworkCredential(<span class="hljs-string">&quot;admin&quot;</span>,<span class="hljs-string">&quot;pwd&quot;</span>);<br><br><span class="hljs-comment">//2. 设置头部和尾部信息</span><br><span class="hljs-comment">//2.1 头部格式</span><br><span class="hljs-comment">//    --boundry字符</span><br><span class="hljs-comment">//    Content-Disposition:form-data;name=&quot;文件数据名&quot;;filename=&quot;上传后名&quot;</span><br><span class="hljs-comment">//    Content-Type:自定义文件类型对应的Type</span><br><span class="hljs-comment">//    空行</span><br><span class="hljs-built_in">string</span> head = <span class="hljs-string">$&quot;--<span class="hljs-subst">&#123;boundry&#125;</span>\r\n&quot;</span> + <br>      <span class="hljs-string">&quot;Content-Disposition:form-data;name=\&quot;file\&quot;;filename=\&quot;a.exe\&quot;\r\n&quot;</span> +<br>      <span class="hljs-string">&quot;Content-Type:application/octet-stream\r\n\r\n&quot;</span>;<br><span class="hljs-built_in">byte</span>[] headBytes = Encoding.UTF8.GetBytes(head);<br><span class="hljs-comment">//2.2 尾部格式</span><br><span class="hljs-comment">//    --boundry字符--</span><br><span class="hljs-built_in">byte</span>[] endBytes = Encoding.UTF8.GetBytes(<span class="hljs-string">$&quot;\r\n--<span class="hljs-subst">&#123;boundry&#125;</span>--\r\n&quot;</span>);<br><br><span class="hljs-comment">//3. 文件</span><br><span class="hljs-keyword">using</span>(FileStream fs = File.OpenRead(<span class="hljs-string">&quot;本地文件.exe&quot;</span>))<br>&#123;<br>  rq.ContentLength = headBytes.Length + fs.Length + endBytes.Length;<br>  Stream uploadStream = rq.GetRequestStream(); <span class="hljs-comment">/*上传流*/</span><br>  uploadStream.Write(headBytes,<span class="hljs-number">0</span>,headBytes.Length); <span class="hljs-comment">/*头部字节*/</span><br>  <span class="hljs-built_in">byte</span>[] fileBytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">2048</span>]; <span class="hljs-comment">/*文件字节*/</span><br>  <span class="hljs-built_in">int</span> l = fs.Read(fileBytes,<span class="hljs-number">0</span>,fileBytes.Length);<br>  <span class="hljs-keyword">while</span>(l!=<span class="hljs-number">0</span>)&#123;<br>    uploadStream.Write(fileBytes,<span class="hljs-number">0</span>,fileBytes.Length);<br>    l = fs.Read(fileBytes,<span class="hljs-number">0</span>,fileBytes.Length);<br>  &#125;<br>  uploadStream.Write(endBytes,<span class="hljs-number">0</span>,endBytes.Length);<br>  uploadStream.Close();<br>  fs.Close();<br>&#125;<br><br><span class="hljs-comment">//4. 上传, 获得响应</span><br>HttpWebResponse res = rq.GetResponse() <span class="hljs-keyword">as</span> HttpWebResponse;<br><span class="hljs-keyword">if</span>(res.StatusCode == HttpStatusCode.OK)&#123;<br>  <span class="hljs-comment">//成功</span><br>&#125; <span class="hljs-keyword">else</span>&#123;<br>  <span class="hljs-comment">//失败</span><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>上传数据单例管理</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HttpMgr</span><br>&#123;<br>  <span class="hljs-keyword">private</span> HttpStatusCode result = HttpStatusCode.BadRequest;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UploadFile</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> fileName, <span class="hljs-built_in">string</span> localPath, UnityAction&lt;HttpStatusCode&gt; action</span>)</span><br>  &#123;<br>    <span class="hljs-keyword">await</span> Task.Run(() =&gt; &#123;<br>      HttpWebRequest rq = HttpWebRequest.Create(HTTP_PATH) <span class="hljs-keyword">as</span> HttpWebRequest;<br>      rq.Method = WebRequestMethods.Http.Post;<br>      rq.Timeout = <span class="hljs-number">30000</span>; <span class="hljs-comment">//根据文件大小设置</span><br>      <span class="hljs-built_in">string</span> boundry = DataTime.Now;<br>      rq.ContentType = <span class="hljs-string">&quot;application/form-data;boundry=&quot;</span> + boundry;<br>      rq.PreAuthenticate = <span class="hljs-literal">true</span>;<br>      rq.Credentials = n;<br>      <span class="hljs-built_in">string</span> head = <span class="hljs-string">$&quot;--<span class="hljs-subst">&#123;boundry&#125;</span>\r\n&quot;</span> + <br>      <span class="hljs-string">$&quot;Content-Disposition:form-data;name=\&quot;file\&quot;;filename=\&quot;<span class="hljs-subst">&#123;fileName&#125;</span>\&quot;\r\n&quot;</span> +<br>      <span class="hljs-string">&quot;Content-Type:application/octet-stream\r\n\r\n&quot;</span>;<br>      <span class="hljs-built_in">byte</span>[] headBytes = Encoding.UTF8.GetBytes(head);<br>      <span class="hljs-built_in">byte</span>[] endBytes = Encoding.UTF8.GetBytes(<span class="hljs-string">$&quot;\r\n--<span class="hljs-subst">&#123;boundry&#125;</span>--\r\n&quot;</span>);<br>      <span class="hljs-keyword">try</span><br>      &#123;<br>        <span class="hljs-keyword">using</span>(FileStream fs = File.OpenRead(<span class="hljs-string">&quot;本地文件.exe&quot;</span>))<br>        &#123;<br>          rq.ContentLength = headBytes.Length + fs.Length + endBytes.Length;<br>          Stream uploadStream = rq.GetRequestStream();<br>          uploadStream.Write(headBytes,<span class="hljs-number">0</span>,headBytes.Length);<br>          <span class="hljs-built_in">byte</span>[] fileBytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">2048</span>];<br>          <span class="hljs-built_in">int</span> l = fs.Read(fileBytes,<span class="hljs-number">0</span>,fileBytes.Length);<br>          <span class="hljs-keyword">while</span>(l!=<span class="hljs-number">0</span>)&#123;<br>            uploadStream.Write(fileBytes,<span class="hljs-number">0</span>,fileBytes.Length);<br>            l = fs.Read(fileBytes,<span class="hljs-number">0</span>,fileBytes.Length);<br>          &#125;<br>          uploadStream.Write(endBytes,<span class="hljs-number">0</span>,endBytes.Length);<br>          uploadStream.Close();<br>          fs.Close();<br>        &#125;<br>        HttpWebResponse res = rq.GetResponse() <span class="hljs-keyword">as</span> HttpWebResponse;<br>        result = HttpStatusCode.OK;<br>        res.Close();<br>      &#125;<br>      <span class="hljs-keyword">catch</span> (Exception e)<br>      &#123;<br>        Debug.Log(e.Message);<br>      &#125;<br>    &#125;);<br>    action?.Invoke(result);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h4 id="Unity相关类"><a href="#Unity相关类" class="headerlink" title="Unity相关类"></a><a href="#%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93http"><code>Unity</code>相关类</a></h4><ul>
<li><code>WWW</code>类<blockquote>
<p>支持协议: <code>http(s)</code>, <code>ftp</code>匿名下载, <code>file</code>三端本地文件异步加载<br><br>一般配合协程使用<br>; 不支持携带账户密码等信息<br><em><strong>过时类</strong></em>, 整合进<code>UnityWebRequest</code>中, 但仍可以使用</p>
</blockquote>
<ul>
<li>方法<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//构造</span><br>WWW www = <span class="hljs-keyword">new</span> WWW(<span class="hljs-string">&quot;文件地址.jpeg&quot;</span>);<br><br><span class="hljs-comment">//将下载数据转换为AudioClip/MovieTexture</span><br>www.GetAudioClip();<br>www.GetMovieTexture();<br><br><span class="hljs-comment">//转换为Texture2D</span><br>Texture2D t = <span class="hljs-keyword">new</span> (<span class="hljs-number">96</span>,<span class="hljs-number">96</span>);<br>www.LoadImageIntoTexture(t);<br></code></pre></td></tr></table></figure></li>
<li>变量<ul>
<li><code>assetBundle</code>: 直接转换为AB包资源</li>
<li><code>text</code>: 直接转换为文本读取</li>
<li><code>bytes</code>: 以<code>byte[]</code>形式加载数据</li>
<li><code>bytesDownloaded</code>: 下载中时已下载的字节数</li>
<li><code>error</code>: 下载中出错时返回错误信息, 如果<code>www.error!=null</code>则出错了</li>
<li><code>isDone</code>: 下载是否已完成</li>
<li><code>progress</code>: 下载进度(0-1)</li>
</ul>
</li>
<li>异步下载流程<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs C#">StartCoroutine(Download());<br><span class="hljs-function">IEnumerator <span class="hljs-title">Download</span>()</span><br>&#123;<br>  WWW w = <span class="hljs-keyword">new</span> (<span class="hljs-string">&quot;http/ftp/file下载直链&quot;</span>);<br>  <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> w; <span class="hljs-comment">//先return, 同时等待w加载结束再加载后面的代码</span><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">  //返回进度</span><br><span class="hljs-comment">  while(!w.isDOne)&#123;</span><br><span class="hljs-comment">    print(w.bytesDownloaded);</span><br><span class="hljs-comment">    print(w.progress);</span><br><span class="hljs-comment">    yield return null;</span><br><span class="hljs-comment">  &#125;</span><br><span class="hljs-comment">  */</span><br>  <span class="hljs-keyword">if</span>(w.error == <span class="hljs-literal">null</span>)&#123;<br>    <span class="hljs-comment">//加载成功</span><br>    <span class="hljs-comment">//直接使用w.GetXXX()或w.xxx获取对应资源</span><br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>    print(w.error);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>异步下载单例管理<code>NetWWWMgr</code><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//同样动态添加一个空GO并挂载</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NetWWWMgr</span>:<span class="hljs-title">MonoBehaviour</span><br>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> NetWWWMgr instance;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NetWWWMgr Instance =&gt; instance;<br><br>  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Awake</span>()</span><br>  &#123;<br>    instance = <span class="hljs-keyword">this</span>;<br>    DontDestroyOnLoad(<span class="hljs-keyword">this</span>.gameObject);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LoadRes</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-built_in">string</span> path, UnityAction&lt;T&gt; action</span>) </span><br><span class="hljs-function">                                                        <span class="hljs-keyword">where</span> T:<span class="hljs-keyword">class</span></span><br>  &#123;<br>    StartCoroutine(Download&lt;T&gt;(path,action));<br>  &#125;<br>  <span class="hljs-function">IEnumerator <span class="hljs-title">Download</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-built_in">string</span> path, UnityAction&lt;T&gt; action</span>) </span><br><span class="hljs-function">                                                        <span class="hljs-keyword">where</span> T:<span class="hljs-keyword">class</span></span><br>    &#123;<br>      WWW w = <span class="hljs-keyword">new</span> (path);<br>      <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> w;<br>      <span class="hljs-keyword">if</span>(w.error == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-keyword">switch</span>(<span class="hljs-keyword">typeof</span>(T))<br>        &#123;<br>          <span class="hljs-function"><span class="hljs-keyword">case</span> <span class="hljs-title">typeof</span>(<span class="hljs-params">AssetBundle</span>):</span><br><span class="hljs-function">            action?.<span class="hljs-title">Invoke</span>(<span class="hljs-params">w.assetBundle <span class="hljs-keyword">as</span> T</span>)</span>;<br>            <span class="hljs-keyword">break</span>;<br>          <span class="hljs-function"><span class="hljs-keyword">case</span> <span class="hljs-title">typeof</span>(<span class="hljs-params">Texture</span>):</span><br><span class="hljs-function">            action?.<span class="hljs-title">Invoke</span>(<span class="hljs-params">w.texture <span class="hljs-keyword">as</span> T</span>)</span>;<br>            <span class="hljs-keyword">break</span>;<br>          <span class="hljs-function"><span class="hljs-keyword">case</span> <span class="hljs-title">typeof</span>(<span class="hljs-params">AudioClip</span>):</span><br><span class="hljs-function">            action?.<span class="hljs-title">Invoke</span>(<span class="hljs-params">w.GetAudioClip(</span>) <span class="hljs-keyword">as</span> T)</span>;<br>            <span class="hljs-keyword">break</span>;<br>          <span class="hljs-function"><span class="hljs-keyword">case</span> <span class="hljs-title">typeof</span>(<span class="hljs-params"><span class="hljs-built_in">string</span></span>):</span><br><span class="hljs-function">            action?.<span class="hljs-title">Invoke</span>(<span class="hljs-params">w.text <span class="hljs-keyword">as</span> T</span>)</span>;<br>            <span class="hljs-keyword">break</span>;<br>          <span class="hljs-function"><span class="hljs-keyword">case</span> <span class="hljs-title">typeof</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[]</span>):</span><br><span class="hljs-function">            action?.<span class="hljs-title">Invoke</span>(<span class="hljs-params">w.bytes <span class="hljs-keyword">as</span> T</span>)</span>;<br>            <span class="hljs-keyword">break</span>;<br>          <span class="hljs-comment">//其他自定义类型</span><br>        &#125;<br>      &#125;<span class="hljs-keyword">else</span>&#123;<br>        print(w.error);<br>      &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><code>WWWForm</code>类<blockquote>
<p>功能: 使用http post上传数据, 需要配合后端处理获得的数据</p>
</blockquote>
<ul>
<li>方法<ul>
<li>构造函数<code>WWWform data = new ()</code></li>
<li>添加二进制数据<code>data.AddBinaryData(字段名,byte[],文件名,文件类型)</code></li>
<li>添加字段<code>data.AddField()</code></li>
</ul>
</li>
<li>上传流程<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs C#">StartCoroutine(UpdateData());<br><span class="hljs-function">IEnumerator <span class="hljs-title">UpdateData</span>()</span><br>&#123;<br>  WWWForm wf = <span class="hljs-keyword">new</span> ();<br>  wf.AddField(<span class="hljs-string">&quot;Name&quot;</span>,<span class="hljs-string">&quot;John&quot;</span>,Encoding.UTF8);<br>  wf.AddField(<span class="hljs-string">&quot;Age&quot;</span>,<span class="hljs-number">18</span>);<br>  wf.AddBinaryData(<span class="hljs-string">&quot;file&quot;</span>,FIle.ReadAllBytes(<span class="hljs-string">&quot;本地文件名.exe&quot;</span>));<br>  wf.AddBinaryData(<span class="hljs-string">&quot;file2&quot;</span>,<span class="hljs-comment">/*otherFIle*/</span>,<span class="hljs-string">&quot;/a.exe&quot;</span>,<br>                                  <span class="hljs-string">&quot;application/octet-stream&quot;</span>);<br>  WWW w = <span class="hljs-keyword">new</span> (<span class="hljs-string">&quot;上传地址&quot;</span>,wf);<br>  <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> w;<br>  <span class="hljs-keyword">if</span>(w.error==<span class="hljs-literal">null</span>)&#123;<br>    <span class="hljs-comment">//成功</span><br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>    Debug.Log(w.error);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>上传<code>BaseMsg</code>单例<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NetWWWMgr</span>:<span class="hljs-title">MonoBehaviour</span><br>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendMsg</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">BaseMsg m, UnityAction&lt;T&gt; action</span>) <span class="hljs-keyword">where</span> T:BaseMsg</span><br>  &#123;<br>    StartCoroutine(SendMsgAsync&lt;T&gt;(m,action));<br>  &#125;<br><br>  <span class="hljs-function">IEnumerator <span class="hljs-title">SendMsgAsync</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">BaseMsg m, UnityAction&lt;T&gt; action</span>) <span class="hljs-keyword">where</span> T:BaseMsg</span><br>  &#123;<br>    WWWForm wf = <span class="hljs-keyword">new</span> ();<br>    wf.AddBinaryData(<span class="hljs-string">&quot;Msg&quot;</span>,m.Writing());<br>    WWW w = <span class="hljs-keyword">new</span> (<span class="hljs-string">&quot;上传地址&quot;</span>,wf);<br>    <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> w;<br>    <span class="hljs-keyword">if</span>(w.error==<span class="hljs-literal">null</span>)&#123;<br>      <span class="hljs-comment">//成功, 解析返回的BaseMsg</span><br>      <span class="hljs-comment">//Invoke解析的信息</span><br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>      Debug.Log(w.error);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><code>UnityWebRequest</code>类<blockquote>
<p>集成了<code>WWW</code>相关功能, 同样使用协程, 支持<code>http</code>&#x2F;<code>ftp</code>&#x2F;<code>file</code>, 支持下载上传<br><br>常用操作: Get文本, Get二进制, Get纹理, Get AB包, Post数据</p>
</blockquote>
<ul>
<li><code>Get</code>数据流程<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-function">IEnumerator <span class="hljs-title">LoadText</span>()</span><br>&#123;<br>  UnityWenRequest rq = UnityWebRequest.Get(<span class="hljs-string">&quot;s.txt&quot;</span>);<br>  <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> rq.SendWebRequest();<br>  <span class="hljs-keyword">if</span>(rq.result == UnityWebRequest.Result.Success)&#123;<br>    print(rq.dowmloadHandler.text); <span class="hljs-comment">//文本</span><br>    <span class="hljs-built_in">byte</span>[] bytes = rq.dowmloadHandler.data; <span class="hljs-comment">//二进制数据</span><br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>    Debug.Log(rq.result + rq.error + rq.responseCode);<br>  &#125;<br>&#125;<br><br><span class="hljs-function">IEnumerator <span class="hljs-title">LoadTexture</span>()</span><br>&#123;<br>  UnityWenRequest rq = UnityWebRequestTexture.GetTexture(<span class="hljs-string">&quot;纹理地址&quot;</span>);<br>  <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> rq.SendWebRequest();<br>  <span class="hljs-keyword">if</span>(rq.result == UnityWebRequest.Result.Success)&#123;<br>    go.Texture = DownloadHandlerTexture.GetContent(rq);<br>    <span class="hljs-comment">//或者</span><br>    <span class="hljs-comment">//(rq.downloadHandler as DownloadHandlerTexture).texture;</span><br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>    Debug.Log(rq.result + rq.error + rq.responseCode);<br>  &#125;<br>&#125;<br><br><span class="hljs-function">IEnumerator <span class="hljs-title">LoadAB</span>()</span><br>&#123;<br>  UnityWenRequest rq = UnityWebRequestAssetBundle.GetAssetBundle(<span class="hljs-string">&quot;地址&quot;</span>);<br>  <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> rq.SendWebRequest();<br>  <span class="hljs-keyword">if</span>(rq.result == UnityWebRequest.Result.Success)&#123;<br>    AssetBundle ab = DownloadHandlerAssetBundle.GetContent(rq);<br>    <span class="hljs-comment">//或者</span><br>    <span class="hljs-comment">//(rq.downloadHandler as DownloadHandlerAssetBundle).assetBundle;</span><br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>    Debug.Log(rq.result + rq.error + rq.responseCode);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><code>Post</code>数据流程<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//所有数据都继承了IMultipartFormSection接口, 使用该接口装数据</span><br>List&lt;IMultipartFormSection&gt; list = <span class="hljs-keyword">new</span> ();<br><span class="hljs-comment">//使用IMultipartFormDataSectino装键值对, 值可以是任何内容</span><br>list.Add(<span class="hljs-keyword">new</span> IMultipartFormDataSection(<span class="hljs-string">&quot;Name&quot;</span>,<span class="hljs-string">&quot;John&quot;</span>));<br><span class="hljs-comment">//使用IMultipartFormFileSectino传文件</span><br><span class="hljs-comment">//  文件名,字节数组</span><br>    list.Add(<span class="hljs-keyword">new</span> IMultipartFormFileSection(<span class="hljs-string">&quot;a.exe&quot;</span>, File.ReadAllBytes(<span class="hljs-string">&quot;文件地址&quot;</span>)));<br><span class="hljs-comment">//  字符串, 文件名</span><br>    list.Add(<span class="hljs-keyword">new</span> IMultipartFormFileSectino(<span class="hljs-string">&quot;hello&quot;</span>,<span class="hljs-string">&quot;服务器地址.txt&quot;</span>));<br><span class="hljs-comment">//  字符串, 编码格式, 文件名</span><br><span class="hljs-comment">//  表单名, 字节数组, 文件名, 文件类型</span><br></code></pre></td></tr></table></figure>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-function">IEnumerator <span class="hljs-title">Upload</span>()</span><br>&#123;<br>  List&lt;IMultipartFormSection&gt; list = <span class="hljs-keyword">new</span> ();<br>  <span class="hljs-comment">//list.Add() 添加键值对</span><br>  UnityWenRequest rq = UnityWebRequest.Post(<span class="hljs-string">&quot;地址&quot;</span>,list);<br>  rq.SendWebRequest();<br>  <span class="hljs-keyword">while</span>(!rq.isDone)&#123;<br>    print(rq.uploadProgress);<br>    <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span>(rq.result == UnityWebRequest.Result.Success)&#123;<br>    print(<span class="hljs-string">&quot;成功&quot;</span>);<br>  &#125;<span class="hljs-keyword">else</span>&#123;<br>    Debug.Log(rq.result + rq.error + rq.responseCode);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><code>Post</code>上传单例<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NetWWWMgr</span>:<span class="hljs-title">MonoBehaviour</span><br>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UploadFile</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> filename, <span class="hljs-built_in">string</span> localPath, UnityAction action</span>)</span><br>  &#123;<br>    StartCoroutine(UploadFileAsync(filename,localPath,action));<br>  &#125;<br>  <span class="hljs-function">IEnumerator <span class="hljs-title">UploadFileAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> filename, <span class="hljs-built_in">string</span> localPath, UnityAction action</span>)</span><br>  &#123;<br>    List&lt;IMultipartFormSection&gt; list = <span class="hljs-keyword">new</span> ();<br>    list.Add(<span class="hljs-keyword">new</span> IMultipartFormDataSection(filename, File.ReadAllBytes(localPath));<br>    UnityWenRequest rq = UnityWebRequest.Post(<span class="hljs-string">&quot;地址&quot;</span>,list);<br>    rq.SendWebRequest();<br>    <span class="hljs-keyword">while</span>(!rq.isDone)&#123;<br>      print(rq.uploadProgress);<br>      <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    action?.Invoke(rq.result);<br>    <span class="hljs-keyword">if</span>(rq.result == UnityWebRequest.Result.Success)&#123;<br>      print(<span class="hljs-string">&quot;成功&quot;</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>      Debug.Log(rq.result + rq.error + rq.responseCode);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><code>Get</code>自定义类型数据<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//关键类:</span><br><span class="hljs-comment">//1. DownloadHandlerBuffer 简单二进制数据</span><br><span class="hljs-comment">//2. DownloadHandlerFile 下载保存文件(占用小)</span><br><span class="hljs-comment">//3. DownloadHandlerTexture/AssetBundle/AudioClip 下载图片/AB包/音频</span><br><span class="hljs-comment">//4. DownloadHandlerScript 可继承的类, 用于自定义数据</span><br><span class="hljs-function">IEnumerator <span class="hljs-title">DownloadBuffer</span>()</span><br>&#123;<br>  UnityWebRequest r = <span class="hljs-keyword">new</span> (<span class="hljs-string">&quot;地址&quot;</span>,UnityWebRequest.kHttpVerbGET);<br>  r.downloadHandler = <span class="hljs-keyword">new</span> DownloadHandlerBuffer();<span class="hljs-comment">/*替换不同内容*/</span><br>  <span class="hljs-keyword">yield</span> <span class="hljs-keyword">return</span> r.SendWebRequest();<br>  <span class="hljs-keyword">if</span>(r.result == UnityWebRequest.Result.Success)&#123;<br>      <span class="hljs-comment">//数据: r.downloadHandlerBuffer.data</span><br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>      Debug.Log(r.result + r.error + r.responseCode);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//自定义数据类</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CustomDOwnloadHandler</span>:<span class="hljs-title">DOwnloadHandlerScript</span><br>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> savePath;<br>  <span class="hljs-keyword">private</span> <span class="hljs-built_in">byte</span>[] cacheBytes;<br>  <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CustomDOwnloadHandler</span>():<span class="hljs-title">base</span>()</span>&#123;&#125;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CustomDOwnloadHandler</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes</span>):<span class="hljs-title">base</span>(<span class="hljs-params">bytes</span>)</span>&#123;&#125;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CustomDOwnloadHandler</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> path</span>):<span class="hljs-title">base</span>()</span>&#123;<br>    <span class="hljs-keyword">this</span>.savePPth = path;<br>  &#125;<br><br>  <span class="hljs-comment">//获取数据</span><br>  <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">GetData</span>()</span><br>  &#123;<br>    <span class="hljs-keyword">return</span> cacheBytes;<br>  &#125;<br><br>  <span class="hljs-comment">//收到数据后每帧自动调用</span><br>  <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">ReceiveData</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] data, <span class="hljs-built_in">int</span> dataLength</span>)</span><br>  &#123;<br>    data.CopyTo(cacheBytes, index);<br>    index += data.Length;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>  <span class="hljs-comment">//消息收完自动调用</span><br>  <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">CompleteContent</span>()</span><br>  &#123;<br>    <span class="hljs-comment">//保存到本地</span><br>    File.WriteAllBytes(savePath, cacheBytes);<br>    <span class="hljs-comment">//或者其他解析操作</span><br>  &#125;<br><br>  <span class="hljs-comment">//收到ContentLength标头时自动调用</span><br>  <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ReceiveContentLengthHeader</span>(<span class="hljs-params"><span class="hljs-built_in">ulong</span> contentLength</span>)</span><br>  &#123;<br>    cacheBytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[contentLength];<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><code>Post</code>自定义数据类型<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//关键类</span><br><span class="hljs-comment">//1. UploadHandlerRaw 字节数组</span><br><span class="hljs-comment">//2. UploadHandlerFile 文件</span><br><span class="hljs-comment">//用法同上, 实际使用较少</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="消息处理"><a href="#消息处理" class="headerlink" title="消息处理"></a><a href="#%E7%9B%AE%E5%BD%95">消息处理</a></h2><h3 id="分包与黏包"><a href="#分包与黏包" class="headerlink" title="分包与黏包"></a><a href="#%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86">分包与黏包</a></h3><h3 id="自定义协议工具"><a href="#自定义协议工具" class="headerlink" title="自定义协议工具"></a><a href="#%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86">自定义协议工具</a></h3><ul>
<li>协议(消息)生成工具<blockquote>
<p>每一种消息对应一种消息类, 在不同语言中的处理方式不同, 因而使用<code>xml</code>(或<code>json</code>)语言来定义消息类, 然后使用工具根据<code>xml</code>消息类统一生成不同语言对应的消息类代码</p>
</blockquote>
<ul>
<li>编辑<code>xml</code>文件<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">message</span>&gt;</span><br>  <span class="hljs-comment">&lt;!--枚举配置--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">enum</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;E_PLAYER_TYPE&quot;</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;PLAYER&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;P1&quot;</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">field</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;P2&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">enum</span>&gt;</span><br>  <span class="hljs-comment">&lt;!--数据结构类配置--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">data</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;PlayerInfo&quot;</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;Player&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;int&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;id&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;string&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;List&quot;</span> <span class="hljs-attr">T</span>=<span class="hljs-string">&quot;int&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;list&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">data</span>&gt;</span><br>  <span class="hljs-comment">&lt;!--消息类配置--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">msg</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;1001&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;PlayerMsg&quot;</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;Player&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">field</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;PlayerInfo&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;data&quot;</span>/&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">msg</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">message</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
<li>读取<code>xml</code>信息<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs C#">XmlDocument xml = <span class="hljs-keyword">new</span> ();<br>xml.Load(<span class="hljs-string">&quot;地址文件.xml&quot;</span>);<br><span class="hljs-comment">//选择唯一节点</span><br>XmlNode root = xml.SelectSingleNode(<span class="hljs-string">&quot;message&quot;</span>);<br><span class="hljs-comment">//选择一个节点下的所有节点</span><br>XmlNodeList enumList = root.SelectNodes(<span class="hljs-string">&quot;enum&quot;</span>);<br><span class="hljs-keyword">foreach</span>(XmlNode x <span class="hljs-keyword">in</span> enumList)&#123;<br>  <span class="hljs-comment">//输出每个枚举的属性</span><br>  print(x.Attribute[<span class="hljs-string">&quot;name&quot;</span>].Value);<br>  print(x.Attribute[<span class="hljs-string">&quot;namespace&quot;</span>].Value);<br>  <span class="hljs-comment">//输出枚举下的所有值</span><br>  XmlNodeList fields = x.SelectNodes(<span class="hljs-string">&quot;field&quot;</span>);<br>  <span class="hljs-keyword">foreach</span>(XmlNode f <span class="hljs-keyword">in</span> x)&#123;<br>    print(f.Attribute[<span class="hljs-string">&quot;type&quot;</span>].Value + <span class="hljs-string">&quot; &quot;</span> + f.Attribute[<span class="hljs-string">&quot;name&quot;</span>].Value);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>创建Unity菜单<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProtocolTool</span><br>&#123;<br>  [<span class="hljs-meta">MenuItem(<span class="hljs-string">&quot;ProtocolTool/创建C#脚本&quot;</span>)</span>]<br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GenerateCSharp</span>()</span><br>  &#123;<br>    <span class="hljs-comment">//内部拼接字符串</span><br>  &#125;<br><br>  [<span class="hljs-meta">MenuItem(<span class="hljs-string">&quot;ProtocolTool/创建Java脚本&quot;</span>)</span>]<br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GenerateJava</span>()</span><br>  &#123;&#125;<br><br>  [<span class="hljs-meta">MenuItem(<span class="hljs-string">&quot;ProtocolTool/创建C++脚本&quot;</span>)</span>]<br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GenerateCpp</span>()</span><br>  &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="第三方协议工具Protobuf"><a href="#第三方协议工具Protobuf" class="headerlink" title="第三方协议工具Protobuf"></a><a href="#%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86">第三方协议工具<code>Protobuf</code></a></h3><p>谷歌开发的生成工具</p>
<h4 id="Protobuf"><a href="#Protobuf" class="headerlink" title="Protobuf"></a><a href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E5%8D%8F%E8%AE%AE%E5%B7%A5%E5%85%B7protobuf"><code>Protobuf</code></a></h4><ul>
<li>下载开发平台的<code>dll</code>, 下载运行平台的编译器, 使用<code>.proto</code>扩展名</li>
<li>导入<code>dll</code>文件</li>
<li><code>proto</code>文件配置规则<ul>
<li>注释: 同<code>C#</code></li>
<li>版本号: 默认<code>&quot;proto2&quot;</code>, 必须放在第一行, <code>syntax=&quot;proto3&quot;;</code></li>
<li>命名空间: <code>package 名;</code></li>
<li>消息类: <code>message 类名&#123;/*声明*/&#125;</code></li>
<li>成员类型和唯一编号<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs proto">//浮点数: float double<br>float f = 1;<br>//整数<br>//  变长: int32 int64 uint32 uint64 sint32 sint64<br>int32 i = 2;<br>uint32 ui = 3; //正数<br>sint32 si = 4; //负数<br>//  固定: fixed32 fixed64 sfixed32 sfixed64<br>fixed32 fx = 5; //始终是4个字节<br>//其他: bool(默认false) string bytes(字符串字节数组, 少用)<br>//每个变量必须有一个唯一编号<br></code></pre></td></tr></table></figure></li>
<li>变量修饰符<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs proto">//数组: repeated<br>repeated int32 listInt = 6; //类似List&lt;int&gt;<br>//字段是否必须赋值: required(不支持proto3) optional<br>//字典: map<br>map&lt;int32,string&gt; m = 7; //类似Dictionary&lt;int,string&gt;<br></code></pre></td></tr></table></figure></li>
<li>枚举<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs proto">TestEnum testEnum = 8;<br>enum TestEnum&#123;<br>  First = 0; //第一个必须是0<br>  Second = 5;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>自定义类对象, 同样需要编号, 默认为<code>null</code></li>
<li>更新删除变量时, 注释变量, 并保留唯一编号不准使用: <code>reserved 2, 15 to 19;</code> 保留变量名不准使用: <code>reserved &quot;testEnum&quot;;</code> 两者选其一就可以, 也可以同时使用</li>
<li>导入其他<code>proto</code>: <code>import &quot;另一个路径.proto&quot;;</code>使用时需包含命名空间</li>
</ul>
</li>
<li>生成代码: 传参运行对应平台的<code>protoc.exe</code><ul>
<li>参数(不能有中文): <code>-I=proto文件路径 --csharp_out=输出文件路径 原文件名</code></li>
</ul>
</li>
<li>加入<code>Unity</code>菜单<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ProtobufTool</span><br>&#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> PROTO_PATH = <span class="hljs-string">&quot;proto文件目录&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> CS_PATH = <span class="hljs-string">&quot;proto文件输出CS目录&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> CPP_PATH = <span class="hljs-string">&quot;proto文件输出C++目录&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> JAVA_PATH = <span class="hljs-string">&quot;proto文件输出Java目录&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> PROTOC_PATH = <span class="hljs-string">&quot;编译器路径&quot;</span>;<br>  <br>  [<span class="hljs-meta">MenuItem(<span class="hljs-string">&quot;ProtobufTool/生成C#代码&quot;</span>)</span>]<br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GenerateCS</span>()</span><br>  &#123;<br>    Generate(<span class="hljs-string">&quot;cssharp_out&quot;</span>,CS_PATH);<br>  &#125;<br><br>  [<span class="hljs-meta">MenuItem(<span class="hljs-string">&quot;ProtobufTool/生成C++代码&quot;</span>)</span>]<br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GenerateCPP</span>()</span><br>  &#123;<br>    Generate(<span class="hljs-string">&quot;cpp_out&quot;</span>,CPP_PATH);<br>  &#125;<br><br>  [<span class="hljs-meta">MenuItem(<span class="hljs-string">&quot;ProtobufTool/生成Java代码&quot;</span>)</span>]<br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GenerateJAVA</span>()</span><br>  &#123;<br>    Generate(<span class="hljs-string">&quot;java_out&quot;</span>,JAVA_PATH);<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Generate</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> outCmd, <span class="hljs-built_in">string</span> outPath</span>)</span><br>  &#123;<br>    DirectoryInfo di = Directory.CreateDirectory(PROTO_PATH);<br>    FileInfo[] files = di.GetFiles();<br>    <span class="hljs-keyword">foreach</span>(FileInfo f <span class="hljs-keyword">in</span> files)&#123;<br>      <span class="hljs-keyword">if</span>(f.Extension==<span class="hljs-string">&quot;.proto&quot;</span>)&#123;<br>        Process cmd = <span class="hljs-keyword">new</span> ();<br>        cmd.StartInfo.FileName = PROTO_PATH;<br>        cmd.StartInfo.Arguments = <br>                  <span class="hljs-string">$&quot;-I=<span class="hljs-subst">&#123;PROTO_PATH&#125;</span> --<span class="hljs-subst">&#123;outCmd&#125;</span>=<span class="hljs-subst">&#123;outPath&#125;</span> <span class="hljs-subst">&#123;f&#125;</span>&quot;</span>;<br>        cmd.Start();<br>        Debug.Log(f + <span class="hljs-string">&quot; Completed.&quot;</span>);<br>      &#125;<br>    &#125;<br>    Debug.Log(<span class="hljs-string">&quot;All Completed.&quot;</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li>序列化与反序列化<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//引入Protobuf命名空间</span><br><span class="hljs-comment">//以message Msg&#123;&#125;为例</span><br>Msg msg = <span class="hljs-keyword">new</span> ();<br><span class="hljs-comment">/*填充成员变量*/</span><br><br><span class="hljs-comment">//序列化为本地文件: Protobuf提供基类成员方法WriteTo</span><br><span class="hljs-keyword">using</span>(FileStream fs = File.Create(Application.persistentDataPath + <span class="hljs-string">&quot;/msg.Msg&quot;</span>))&#123;<br>  msg.WriteTo(fs);<br>&#125;<br><br><span class="hljs-comment">//序列化为字节数组: WriteTo到MemoryStream中再ToArray()</span><br><span class="hljs-built_in">byte</span>[] bytes = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">using</span>(MemoryStream ms = <span class="hljs-keyword">new</span> ())&#123;<br>  msg.WriteTo(ms);<br>  bytes = ms.ToArray();<br>&#125;<br><br><span class="hljs-comment">//反序列化到内存中: Protobuf提供基类方法Parser.ParseFrom(字节数组或流)</span><br>Msg rcvMsg = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">using</span>(FileStream fs = File.Read(Application.persistentDataPath + <span class="hljs-string">&quot;/msg.Msg&quot;</span>))&#123;<br>  rcvMsg = Msg.Parser.ParseFrom(fs);<br>&#125;<br><br><span class="hljs-comment">//从字节数组反序列化</span><br>Msg rcvMsg2 = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">using</span>(MemoryStream ms = <span class="hljs-keyword">new</span> (bytes))&#123;<br>  rcvMsg2 = Msg.Parser.ParseFrom(ms);<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>静态工具类<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NetTool</span><br>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">GetProtoBytes</span>(<span class="hljs-params">IMessage msg</span>)</span><br><span class="hljs-function">  <span class="hljs-comment">/*工具将所有写的类继承了IMessage*/</span></span><br>  &#123;<br>    <span class="hljs-keyword">return</span> msg.ToByteArray();<br>  &#125;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-title">GetProtoMsg</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] bytes</span>) <span class="hljs-keyword">where</span> T:<span class="hljs-keyword">class</span>, IMessage</span><br>  &#123;<br>    <span class="hljs-comment">//反射</span><br>    Type type = <span class="hljs-keyword">typeof</span>(T);<br>    PropertyInfo pi = type.GetProperty(<span class="hljs-string">&quot;Parser&quot;</span>);<br>    <span class="hljs-built_in">object</span> parserobj = pi.GetValue(<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>);<br>    Type parserType = parserobj.GetType();<br>    MethodInfo mi = parserType.GetMethod(<span class="hljs-string">&quot;ParseFrom&quot;</span>,<span class="hljs-keyword">new</span> Type[] &#123;<span class="hljs-keyword">typeof</span>(<span class="hljs-built_in">byte</span>[])&#125;);<br>    <span class="hljs-built_in">object</span> msg = mi.Invoke(parserobj,<span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>[] &#123;bytes&#125;);<br>    <span class="hljs-keyword">return</span> msg <span class="hljs-keyword">as</span> T;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">//外部使用</span><br>Msg msg2;<br><span class="hljs-comment">//  把一个msg2序列化</span><br><span class="hljs-built_in">byte</span>[] bytes2 = NetTool.GetProtoBytes(msg2);<br><span class="hljs-comment">//  把一个byte[]反序列化为Msg</span><br>Msg msg3 = NetTool.GetProtoMsg&lt;Msg&gt;(bytes2);<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h4 id="Protobuf-Net"><a href="#Protobuf-Net" class="headerlink" title="Protobuf-Net"></a><a href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E5%8D%8F%E8%AE%AE%E5%B7%A5%E5%85%B7protobuf"><code>Protobuf-Net</code></a></h4><blockquote>
<p>早期的<code>Protobuf</code>不支持<code>C#</code>, 第三方<code>Protobuf-Net</code>添加了对<code>C#</code>的支持. <code>Protobuf</code>不支持<code>.Net3.5</code>及以下版本, 对于较旧的Unity只能使用<code>Protobuf-Net</code>, 新版的Unity可以使用<code>Protobuf</code></p>
</blockquote>
<h3 id="大小端模式-大小端字节序"><a href="#大小端模式-大小端字节序" class="headerlink" title="大小端模式&#x2F;大小端字节序"></a><a href="#%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86">大小端模式&#x2F;大小端字节序</a></h3><ul>
<li>概念<ul>
<li>大端模式: 数据的高字节保存在低地址中, 符合人的阅读习惯</li>
<li>小端模式: 数据的高字节保存在高地址中</li>
</ul>
</li>
<li>产生背景: 计算机系统处理都是小端模式, 人创造大端模式便于阅读</li>
<li>影响: 不同系统不同平台不同语言采用的模式可能不同, 一个数在另一个不同模式的环境中数据不同, 在接收处理数据时必须考虑不同环境的处理<ul>
<li><code>C#</code>与<code>C++</code>为小端模式, <code>Java</code>&#x2F;<code>Erlang</code>&#x2F;<code>AS3</code>是大端模式, 两方之间通信需要进行大小端转换</li>
</ul>
</li>
<li>大小端模式转换<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs C#"><span class="hljs-comment">//short/int/long</span><br><span class="hljs-comment">//  1. 判断是否小端模式</span><br>print(BitConverter.IsLittleEndian); <span class="hljs-comment">//C#和Unity中显示为True</span><br><br><span class="hljs-comment">//  2. 转网络字节序(大端模式)</span><br><span class="hljs-built_in">int</span> i = <span class="hljs-number">99</span>;<br><span class="hljs-built_in">byte</span>[] bytes = BitConverter.GetBytes(i); <span class="hljs-comment">//小端模式的99的byte[]</span><br><span class="hljs-built_in">byte</span>[] bytes2 = BitConverter.GetBytes(IPAddress.HostToNetworkOrder(i));<br><span class="hljs-comment">/*大端模式的99的byte[]*/</span><br><br><span class="hljs-comment">//  3. 网络字节序转本机字节序(大→小)</span><br><span class="hljs-built_in">int</span> i1 = BitConverter.ToInt32(bytes,<span class="hljs-number">0</span>); <span class="hljs-comment">//直接转</span><br><span class="hljs-built_in">int</span> i2 = IPAddress.NetworkToHostOrder(BitConverter.ToInt32(bytes2,<span class="hljs-number">0</span>));<br><span class="hljs-comment">/*大转小*/</span><br><br><span class="hljs-comment">//通用转换: 反转位置</span><br><span class="hljs-keyword">if</span>(BitConverter.IsLittleEndian)&#123;Array.Reverse(bytes);&#125;<br><span class="hljs-comment">/*或*/</span><br><span class="hljs-keyword">if</span>(!BitConverter.IsLittleEndian)&#123;Array.Reverse(bytes);&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<h3 id="消息加密与解密"><a href="#消息加密与解密" class="headerlink" title="消息加密与解密"></a><a href="#%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86">消息加密与解密</a></h3><ul>
<li>单向加密(不可逆): 将数据计算为另一种固定长度的值<ul>
<li>案例: <code>MD5</code>, <code>SHA1</code>, <code>SHA256</code></li>
<li>用途: 网络传输不用, 一般用于为密码加密传输</li>
</ul>
</li>
<li>对称加密: 密钥加密明文, 解密密文<ul>
<li>案例: <code>DES</code>, <code>3DES</code>, <code>IDEA</code>, <code>AES</code></li>
<li>优点: 计算量小, 加密速度快</li>
<li>缺点: 知道了密钥和算法可以破解</li>
<li>用途: 消息传输, 密钥由服务器生成下发, 每次建立通讯都变化</li>
</ul>
</li>
<li>非对称加密&#x2F;公开密钥加密: 分为公钥和私钥, 两者之间不能计算出另一个, 其中一个加密, 只能用另一个解密<ul>
<li>案例: <code>RSA</code>, <code>DSA</code></li>
<li>优点: 安全性高</li>
<li>缺点: 算法复杂, 加密速度慢</li>
<li>用途: 安全性要求较高, 接收速度慢的场景, 如支付<code>SDK</code></li>
</ul>
</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Unity/" class="category-chain-item">Unity</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Unity/" class="print-no-link">#Unity</a>
      
        <a href="/tags/%E7%BD%91%E7%BB%9C/" class="print-no-link">#网络</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/02/19/%E4%BB%80%E4%B9%88%E5%8F%AB%E8%A3%81%E5%91%98%E8%A3%81%E5%88%B0%E5%A4%A7%E5%8A%A8%E8%84%89%EF%BC%9F/" title="什么叫裁员裁到大动脉？">
                        <span class="hidden-mobile">什么叫裁员裁到大动脉？</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="waline"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#waline', function() {
      Fluid.utils.createCssLink('https://cdn.staticfile.org/waline/2.15.5/waline.min.css')
      Fluid.utils.createScript('https://cdn.staticfile.org/waline/2.15.5/waline.min.js', function() {
        var options = Object.assign(
          {"serverURL":"https://tvwzrcmn.api.lncldglobal.com  ","path":"window.location.pathname","meta":["nick","mail","link"],"requiredMeta":["nick"],"lang":"zh-CN","emoji":["https://cdn.jsdelivr.net/gh/walinejs/emojis/weibo"],"dark":"html[data-user-color-scheme=\"dark\"]","wordLimit":100,"pageSize":10},
          {
            el: '#waline',
            path: window.location.pathname
          }
        )
        Waline.init(options);
        Fluid.utils.waitElementVisible('#waline .vcontent', () => {
          var imgSelector = '#waline .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/js/typing-effect.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
